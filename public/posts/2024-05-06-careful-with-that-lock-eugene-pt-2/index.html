<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Careful with That Lock, Eugene: Part 2 | Robin's blog</title>
<meta name=keywords content="postgres,rust,eugene"><meta name=description content="A while back, I wrote
Careful with That Lock, Eugene about an
idea for how to check if a database migration is likely to disturb production.
That post came about after having an inspiring chat with a colleague about
the advantages of transactional migration scripts and the ability to check
the postgres system catalog views before committing a transaction.
Over the past few weeks, I&rsquo;ve been experimenting with this idea to test if I can
use it to build valuable safety checks for DDL migrations. Kind of like
shellcheck, but for database DDL migrations."><meta name=author content="Robin Kåveland"><link rel=canonical href=https://kaveland.no/posts/2024-05-06-careful-with-that-lock-eugene-pt-2/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://kaveland.no/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kaveland.no/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kaveland.no/favicon-32x32.png><link rel=apple-touch-icon href=https://kaveland.no/apple-touch-icon.png><link rel=mask-icon href=https://kaveland.no/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kaveland.no/posts/2024-05-06-careful-with-that-lock-eugene-pt-2/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer data-domain=kaveland.no src=https://plausible.io/js/script.js></script><meta property="og:title" content="Careful with That Lock, Eugene: Part 2"><meta property="og:description" content="A while back, I wrote
Careful with That Lock, Eugene about an
idea for how to check if a database migration is likely to disturb production.
That post came about after having an inspiring chat with a colleague about
the advantages of transactional migration scripts and the ability to check
the postgres system catalog views before committing a transaction.
Over the past few weeks, I&rsquo;ve been experimenting with this idea to test if I can
use it to build valuable safety checks for DDL migrations. Kind of like
shellcheck, but for database DDL migrations."><meta property="og:type" content="article"><meta property="og:url" content="https://kaveland.no/posts/2024-05-06-careful-with-that-lock-eugene-pt-2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-06T00:00:00+00:00"><meta property="article:modified_time" content="2024-05-06T00:00:00+00:00"><meta property="og:site_name" content="Robin's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Careful with That Lock, Eugene: Part 2"><meta name=twitter:description content="A while back, I wrote
Careful with That Lock, Eugene about an
idea for how to check if a database migration is likely to disturb production.
That post came about after having an inspiring chat with a colleague about
the advantages of transactional migration scripts and the ability to check
the postgres system catalog views before committing a transaction.
Over the past few weeks, I&rsquo;ve been experimenting with this idea to test if I can
use it to build valuable safety checks for DDL migrations. Kind of like
shellcheck, but for database DDL migrations."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kaveland.no/posts/"},{"@type":"ListItem","position":2,"name":"Careful with That Lock, Eugene: Part 2","item":"https://kaveland.no/posts/2024-05-06-careful-with-that-lock-eugene-pt-2/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Careful with That Lock, Eugene: Part 2","name":"Careful with That Lock, Eugene: Part 2","description":"A while back, I wrote Careful with That Lock, Eugene about an idea for how to check if a database migration is likely to disturb production. That post came about after having an inspiring chat with a colleague about the advantages of transactional migration scripts and the ability to check the postgres system catalog views before committing a transaction.\nOver the past few weeks, I\u0026rsquo;ve been experimenting with this idea to test if I can use it to build valuable safety checks for DDL migrations. Kind of like shellcheck, but for database DDL migrations.\n","keywords":["postgres","rust","eugene"],"articleBody":"A while back, I wrote Careful with That Lock, Eugene about an idea for how to check if a database migration is likely to disturb production. That post came about after having an inspiring chat with a colleague about the advantages of transactional migration scripts and the ability to check the postgres system catalog views before committing a transaction.\nOver the past few weeks, I’ve been experimenting with this idea to test if I can use it to build valuable safety checks for DDL migrations. Kind of like shellcheck, but for database DDL migrations.\nAt this point, I’ve made enough progress to share some results. I’ve been working on a Rust project that compiles a command line tool named eugene and published it to crates.io and ghcr.io/kaaveland/eugene. The code lives in kaaveland/eugene and there’s a hacker news thread here.\nThis post is about what eugene can do, how it is implemented, and what I hope to achieve with it in the future.\nDemo: eugene trace report Suppose I have a migration script named alter_column_not_null.sql that looks like this:\n-- alter_column_not_null.sql -- create table books(id serial primary key, title text); -- fix: the title column should be not null alter table books alter column title set not null; -- fix: the title column should be unique alter table books add constraint title_unique unique (title); There exists some table books already, and we want to enforce both that the title column is not null and that it is unique. Suppose you commit this to a branch and make a pull request, then a minute later, the pull request is updated with a comment generated by eugene trace -f markdown alter_column_not_null.sql that looks like this:\nStatement number 1 for 10 ms SQL alter table books alter column title set not null; Locks at start No locks held at the start of this statement.\nNew locks taken Schema Object Mode Relkind OID Safe public books AccessExclusiveLock Table 1 ❌ Hints Validating table with a new NOT NULL column ID: make_column_not_nullable_with_lock\nA column was changed from NULL to NOT NULL. This blocks all table access until all rows are validated. A safer way is: Add a CHECK constraint as NOT VALID, validate it later, then make the column NOT NULL.\nThe column title in the table public.books was changed to NOT NULL. If there is a CHECK (title IS NOT NULL) constraint on public.books, this is safe. Splitting this kind of change into 3 steps can make it safe:\nAdd a CHECK (title IS NOT NULL) NOT VALID; constraint on public.books. Validate the constraint in a later transaction, with ALTER TABLE public.books VALIDATE CONSTRAINT .... Make the column NOT NULL Taking dangerous lock without timeout ID: dangerous_lock_without_timeout\nA lock that would block many common operations was taken without a timeout. This can block all other operations on the table indefinitely if any other transaction holds a conflicting lock while idle in transaction or active. A safer way is: Run SET lock_timeout = '2s'; before the statement and retry the migration if necessary.\nThe statement took AccessExclusiveLock on the Table public.books without a timeout. It blocks SELECT, FOR UPDATE, FOR NO KEY UPDATE, FOR SHARE, FOR KEY SHARE, UPDATE, DELETE, INSERT, MERGE while waiting to acquire the lock.\nStatement number 2 for 10 ms SQL alter table books add constraint title_unique unique (title); Locks at start Schema Object Mode Relkind OID Safe public books AccessExclusiveLock Table 1 ❌ New locks taken Schema Object Mode Relkind OID Safe public books ShareLock Table 1 ❌ Hints Running more statements after taking AccessExclusiveLock ID: holding_access_exclusive\nA transaction that holds an AccessExclusiveLock started a new statement. This blocks all access to the table for the duration of this statement. A safer way is: Run this statement in a new transaction.\nThe statement is running while holding an AccessExclusiveLock on the Table public.books, blocking all other transactions from accessing it.\nCreating a new index on an existing table ID: new_index_on_existing_table_is_nonconcurrent\nA new index was created on an existing table without the CONCURRENTLY keyword. This blocks all writes to the table while the index is being created. A safer way is: Run CREATE INDEX CONCURRENTLY instead of CREATE INDEX.\nA new index was created on the table public.books. The index public.title_unique was created non-concurrently, which blocks all writes to the table. Use CREATE INDEX CONCURRENTLY to avoid blocking writes.\nCreating a new unique constraint ID: new_unique_constraint_created_index\nFound a new unique constraint and a new index. This blocks all writes to the table while the index is being created and validated. A safer way is: CREATE UNIQUE INDEX CONCURRENTLY, then add the constraint using the index.\nA new unique constraint title_unique was added to the table public.books. This constraint creates a unique index on the table, and blocks all writes. Consider creating the index concurrently in a separate transaction, then adding the unique constraint by using the index: ALTER TABLE public.books ADD CONSTRAINT title_unique UNIQUE USING INDEX public.title_unique;\nTaking dangerous lock without timeout ID: dangerous_lock_without_timeout\nA lock that would block many common operations was taken without a timeout. This can block all other operations on the table indefinitely if any other transaction holds a conflicting lock while idle in transaction or active. A safer way is: Run SET lock_timeout = '2s'; before the statement and retry the migration if necessary.\nThe statement took ShareLock on the Table public.books without a timeout. It blocks UPDATE, DELETE, INSERT, MERGE while waiting to acquire the lock.\nHow to perform this change safely eugene has some concrete suggestions for changes we could do to make this migration safer. We should always use lock_timeout when taking locks, and here’s a way to perform this migration in more steps that causes less time with dangerous locks held overall. The hints give us a strategy to perform the migration in several more steps:\nStep 1: Add a CHECK constraint that is NOT VALID This still takes the AccessExclusiveLock on books, but it no longer needs to validate all the rows, so the lock should be held for a shorter time. All inserts or updates on books will only allow title to be not null.\nset lock_timeout = '2s'; alter table books add constraint title_not_null check (title is not null) not valid; Step 2: Validate the constraint This will take a ShareUpdateExclusiveLock on books, which is less restrictive than the AccessExclusiveLock. This is possible, because only “old rows” could possibly be null, so there’s no need to guard against inserts or updates with a lock.\nset lock_timeout = '2s'; alter table books validate constraint title_not_null; Step 3: Make the column not null At this point, postgres already knows that title is not null, so the AccessExclusiveLock is only necessary for updating the catalog, which is instant:\nset lock_timeout = '2s'; alter table books alter column title set not null; Step 4: Add the unique constraint concurrently This returns immediately, and postgres will build up the index and validate the constraint in its own time, generally without blocking other operations:\ncreate unique index concurrently title_unique_idx on books(title); Step 5: Add the unique constraint using the index This is also instant now, since the index is already built and postgres knows that title is unique. The AccessExclusiveLock is again only necessary for updating the catalog:\nset lock_timeout = '2s'; alter table books add constraint title_unique unique using index title_unique_idx; Summary In this instance, eugene was able to provide some valuable hints about how to make migrations that achieve the same result, but is much less likely to cause disturbances in the database.\nThere are many example migration scripts and reports like this in the examples directory of the repository.\nWhen do you need a tool like eugene? Breaking small database changes into this many steps isn’t for everyone. I have worked on many systems where we did migrations all the time without using safeguards like this, and most of the time, it was fine. In many cases, some amount of downtime was acceptable and we could stop the application prior to running DDL. In many other cases, lock_timeout alone would have saved us from issues with slow concurrent transactions and lock queues.\nThere is a lot of value in simplicity and simple migration scripts if you can afford it. Here are some things you may need to deal with if you use the safer approach recommended by eugene:\nIf your statements are unable to take their locks in 2 seconds, your script crashes. You may need retries around your migration deployment. Creating indexes concurrently can take a long time. The statement returns right away and you need to wait for it to finish before you can run the next migration. You must be prepared to handle a deadlock or unique violation that makes it unable to complete the index. Invariably, working like this is going to make you create a lot more migration scripts than you otherwise would have. But if you’d like to learn more about how postgres locking works, and how to avoid common pitfalls when doing migrations, eugene can be a valuable tool. If you’re working on a system where some tables are very large, or have a lot of concurrent transactions where some are slow, eugene could help you avoid “stopping the world” in production when you’re executing migrations.\nOn the whole, I’ve certainly learned a lot about how postgres works while making eugene, and I hope that I can impart some of that learning on others by seeing the tool adopted.\nHow does eugene trace work? eugene has a lot of static data built into it. For example:\nIt knows about which lock modes that conflict with each other, I’ve lifted this from the excellent postgres documentation about locks. It has lots of helpful text snippets that can be used to generate hints. I’ve lifted many of these from the awesome strong_migrations README. But the primary mechanism that it uses is to break down the SQL script into individual statements, that are then run in a transaction. Before and after each statement, important database state is saved in memory, which enables us to calculate the effect that the statement had on several important system views in the database:\npg_class helps eugene figure out which database objects that are visible to other transactions (and maybe in the future, which objects that have been rewritten). pg_locks helps eugene figure out which locks that it owns pg_attribute helps eugene figure out which schema changes that were made to tables pg_constraint helps eugene figure out which constraints that were added, altered or removed This means that there’s a lot of knowledge that eugene does not need to have, for example, it does not need a very good SQL parser, or keep track of which versions of postgres that exhibits what behaviour. If postgres 17 will be able to add constraints with lesser locks, eugene will be able to figure that out.\nRunning the transaction, then optionally committing it results in a big data structure that essentially is a layered diff of database state. eugene trace -f json can emit this structure, so that it could be used by tools like jq, or eugene trace -f md can generate a markdown report like the one above. Both of these are essentially just views of this layered diff.\nHow are hints implemented? It is easy to add new hints to eugene. They consist of a lot of static text, and then a rule that checks a statement level diff for certain conditions. If the conditions are met, the hint is emitted. Here’s an example of a hint rule for the running_statement_while_holding_access_exclusive hint:\nfn running_statement_while_holding_access_exclusive( sql_statement_trace: \u0026FullSqlStatementLockTrace, ) -\u003e Option\u003cString\u003e { let lock = sql_statement_trace .locks_at_start .iter() .find(|lock| lock.mode == \"AccessExclusiveLock\")?; let help = format!( \"The statement is running while holding an `AccessExclusiveLock` on the {} `{}.{}`, \\ blocking all other transactions from accessing it.\", lock.relkind, lock.schema, lock.object_name, ); Some(help) } Here’s another one for discovering columns that changed from NULL to NOT NULL:\nfn make_column_not_nullable_help( sql_statement_trace: \u0026FullSqlStatementLockTrace, ) -\u003e Option\u003cString\u003e { let column = sql_statement_trace .altered_columns .iter() .find(|column| !column.new.nullable \u0026\u0026 column.old.nullable)?; let table_name = format!(\"{}.{}\", column.new.schema_name, column.new.table_name); let col_name = column.new.column_name.as_str(); let help = format!( \"The column `{col_name}` in the table `{table_name}` was changed to `NOT NULL`. \\ If there is a `CHECK ({col_name} IS NOT NULL)` constraint on `{table_name}`, this is safe. \\ Splitting this kind of change into 3 steps can make it safe:\\n\\n\\ 1. Add a `CHECK ({col_name} IS NOT NULL) NOT VALID;` constraint on `{table_name}`.\\n\\ 2. Validate the constraint in a later transaction, with `ALTER TABLE {table_name} VALIDATE CONSTRAINT ...`.\\n\\ 3. Make the column `NOT NULL`\\n\", ); Some(help) } I am hoping for some help to add many more to hints.rs in the future, I am certain that there are many kinds of migration patterns that I do not know about. If you install the tool, you can run eugene hints to display general information about the hints that it knows about, for example:\n{ \"hints\": [ { \"id\": \"validate_constraint_with_lock\", \"name\": \"Validating table with a new constraint\", \"condition\": \"A new constraint was added and it is already `VALID`\", \"effect\": \"This blocks all table access until all rows are validated\", \"workaround\": \"Add the constraint as `NOT VALID` and validate it with `ALTER TABLE ... VALIDATE CONSTRAINT` later\" } // and many more ] } Where to get eugene You can install eugene from crates.io using cargo install eugene --bin, or you can use the docker image ghcr.io/kaaveland/eugene to run the tool. I have been trying to document it well in the github repository. If you want to play around with it, I suggest you clone the repository. There is a docker-compose.yml that boots up a postgres database which is compatible with the example migrations in examples/, so this should get you started:\ndocker-compose up -d # boots postgres on 5432 cargo run trace -f markdown examples/alter_column_not_null.sql \\ glow # glow renders markdown in the terminal beautifully If you make any changes to the source code, you can run cargo test to run the tests, and see the diff on all of the markdown files in examples/ to see the effect of your change.\nThe test setup is using another neat postgres trick from this blog to make sure that the tests can run DDL changes in parallel without conflicting with each other or causing deadlocks.\nOnce you’re satisfied with your changes, you can run cargo install --path . --bin to install the the tool to your system and try it out on your own migrations.\nFuture work I have a lot of ideas for how to improve eugene. Here are some of them:\nAdd more hints. I am hoping for ideas on the issue tracker Read and parse pg_stat_statements to find out which queries that could conflict with migrations. Add a eugene ci command that is suitable for integration with CI/CD pipelines, like pull requests so that you can run eugene ci on a branch and get a report on the pull request. Adding mechanisms to make eugene work like a linter, so it can optionally “fail the build”. Add detection of table and index rewrites, so eugene can tell you if a migration could take an unexpectedly long time. Automatically generate safer migration scripts where it is possible to do this in a deterministic manner. I am hoping to get some feedback on the tool, and I would love some suggestions on the issue tracker for where to go from here.\n","wordCount":"2581","inLanguage":"en","datePublished":"2024-05-06T00:00:00Z","dateModified":"2024-05-06T00:00:00Z","author":{"@type":"Person","name":"Robin Kåveland"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kaveland.no/posts/2024-05-06-careful-with-that-lock-eugene-pt-2/"},"publisher":{"@type":"Organization","name":"Robin's blog","logo":{"@type":"ImageObject","url":"https://kaveland.no/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kaveland.no/ accesskey=h title="Robin's blog (Alt + H)">Robin's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kaveland.no/about/ title=about><span>about</span></a></li><li><a href=https://kaveland.no/projects/ title=projects><span>projects</span></a></li><li><a href=https://kaveland.no/eugene/ title=eugene><span>eugene</span></a></li><li><a href=https://kaveland.no/thumper/ title=thumper><span>thumper</span></a></li><li><a href=https://kaveland.no/tags/ title=tags><span>tags</span></a></li><li><a href=https://kaveland.no/archives/ title=archives><span>archives</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kaveland.no/>Home</a>&nbsp;»&nbsp;<a href=https://kaveland.no/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Careful with That Lock, Eugene: Part 2</h1><div class=post-meta><span title='2024-05-06 00:00:00 +0000 UTC'>May 6, 2024</span>&nbsp;·&nbsp;13 min&nbsp;·&nbsp;2581 words&nbsp;·&nbsp;Robin Kåveland&nbsp;|&nbsp;<a href=https://github.com/kaaveland/kaaveland.github.io/content/posts/2024-05-06-careful-with-that-lock-eugene-pt-2.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#demo-eugene-trace-report>Demo: <code>eugene trace</code> report</a></li><li><a href=#statement-number-1-for-10-ms>Statement number 1 for 10 ms</a><ul><li><a href=#sql>SQL</a></li><li><a href=#locks-at-start>Locks at start</a></li><li><a href=#new-locks-taken>New locks taken</a></li><li><a href=#hints>Hints</a></li></ul></li><li><a href=#statement-number-2-for-10-ms>Statement number 2 for 10 ms</a><ul><li><a href=#sql-1>SQL</a></li><li><a href=#locks-at-start-1>Locks at start</a></li><li><a href=#new-locks-taken-1>New locks taken</a></li><li><a href=#hints-1>Hints</a></li></ul></li></ul><ul><li><a href=#step-1-add-a-check-constraint-that-is-not-valid>Step 1: Add a <code>CHECK</code> constraint that is <code>NOT VALID</code></a></li><li><a href=#step-2-validate-the-constraint>Step 2: Validate the constraint</a></li><li><a href=#step-3-make-the-column-not-null>Step 3: Make the column <code>not null</code></a></li><li><a href=#step-4-add-the-unique-constraint-concurrently>Step 4: Add the unique constraint concurrently</a></li><li><a href=#step-5-add-the-unique-constraint-using-the-index>Step 5: Add the unique constraint using the index</a></li><li><a href=#summary>Summary</a></li><li><a href=#when-do-you-need-a-tool-like-eugene>When do you need a tool like <code>eugene</code>?</a></li></ul><ul><li><a href=#how-are-hints-implemented>How are hints implemented?</a></li></ul></nav></div></details></div><div class=post-content><p>A while back, I wrote
<a href=/posts/2024-04-12-careful-with-that-lock-eugene>Careful with That Lock, Eugene</a> about an
idea for how to check if a database migration is likely to disturb production.
That post came about after having an inspiring chat with a colleague about
the advantages of transactional migration scripts and the ability to check
the postgres system catalog views before committing a transaction.</p><p>Over the past few weeks, I&rsquo;ve been experimenting with this idea to test if I can
use it to build valuable safety checks for DDL migrations. Kind of like
<a href=https://www.shellcheck.net/>shellcheck</a>, but for database DDL migrations.</p><p>At this point, I&rsquo;ve made enough progress to share some results.
I&rsquo;ve been working on a Rust project that compiles a command line tool named
<code>eugene</code> and published it to <a href=https://crates.io/crates/eugene>crates.io</a>
and <code>ghcr.io/kaaveland/eugene</code>. The code lives in
<a href=https://github.com/kaaveland/eugene>kaaveland/eugene</a> and there&rsquo;s a hacker
news thread <a href="https://news.ycombinator.com/item?id=40291241">here</a>.</p><p>This post is about what <code>eugene</code> can do, how it is implemented, and what I hope
to achieve with it in the future.</p><h2 id=demo-eugene-trace-report>Demo: <code>eugene trace</code> report<a hidden class=anchor aria-hidden=true href=#demo-eugene-trace-report>#</a></h2><p>Suppose I have a migration script named <code>alter_column_not_null.sql</code> that looks like
this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- alter_column_not_null.sql
</span></span></span><span class=line><span class=cl><span class=c1>-- create table books(id serial primary key, title text);
</span></span></span><span class=line><span class=cl><span class=c1>-- fix: the title column should be not null
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>alter</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>books</span><span class=w> </span><span class=k>alter</span><span class=w> </span><span class=k>column</span><span class=w> </span><span class=n>title</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- fix: the title column should be unique
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>alter</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>books</span><span class=w> </span><span class=k>add</span><span class=w> </span><span class=k>constraint</span><span class=w> </span><span class=n>title_unique</span><span class=w> </span><span class=k>unique</span><span class=w> </span><span class=p>(</span><span class=n>title</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>There exists some table <code>books</code> already, and we want to enforce both that the <code>title</code>
column is <code>not null</code> and that it is unique. Suppose you commit this to a branch and
make a pull request, then a minute later, the pull request is updated with a comment
generated by <code>eugene trace -f markdown alter_column_not_null.sql</code> that looks like this:</p><div style="border-top:1px dashed;border-bottom:1px dashed"><h2 id=statement-number-1-for-10-ms>Statement number 1 for 10 ms<a hidden class=anchor aria-hidden=true href=#statement-number-1-for-10-ms>#</a></h2><h3 id=sql>SQL<a hidden class=anchor aria-hidden=true href=#sql>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>alter</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>books</span><span class=w> </span><span class=k>alter</span><span class=w> </span><span class=k>column</span><span class=w> </span><span class=n>title</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=locks-at-start>Locks at start<a hidden class=anchor aria-hidden=true href=#locks-at-start>#</a></h3><p>No locks held at the start of this statement.</p><h3 id=new-locks-taken>New locks taken<a hidden class=anchor aria-hidden=true href=#new-locks-taken>#</a></h3><table><thead><tr><th>Schema</th><th>Object</th><th>Mode</th><th>Relkind</th><th>OID</th><th>Safe</th></tr></thead><tbody><tr><td><code>public</code></td><td><code>books</code></td><td><code>AccessExclusiveLock</code></td><td>Table</td><td>1</td><td>❌</td></tr></tbody></table><h3 id=hints>Hints<a hidden class=anchor aria-hidden=true href=#hints>#</a></h3><h4 id=validating-table-with-a-new-not-null-column>Validating table with a new <code>NOT NULL</code> column<a hidden class=anchor aria-hidden=true href=#validating-table-with-a-new-not-null-column>#</a></h4><p>ID: <code>make_column_not_nullable_with_lock</code></p><p>A column was changed from <code>NULL</code> to <code>NOT NULL</code>. This blocks all table access until all rows are validated. A safer way is: Add a <code>CHECK</code> constraint as <code>NOT VALID</code>, validate it later, then make the column <code>NOT NULL</code>.</p><p>The column <code>title</code> in the table <code>public.books</code> was changed to <code>NOT NULL</code>. If there is a <code>CHECK (title IS NOT NULL)</code> constraint on <code>public.books</code>, this is safe. Splitting this kind of change into 3 steps can make it safe:</p><ol><li>Add a <code>CHECK (title IS NOT NULL) NOT VALID;</code> constraint on <code>public.books</code>.</li><li>Validate the constraint in a later transaction, with <code>ALTER TABLE public.books VALIDATE CONSTRAINT ...</code>.</li><li>Make the column <code>NOT NULL</code></li></ol><h4 id=taking-dangerous-lock-without-timeout>Taking dangerous lock without timeout<a hidden class=anchor aria-hidden=true href=#taking-dangerous-lock-without-timeout>#</a></h4><p>ID: <code>dangerous_lock_without_timeout</code></p><p>A lock that would block many common operations was taken without a timeout. This can block all other operations on the table indefinitely if any other transaction holds a conflicting lock while <code>idle in transaction</code> or <code>active</code>. A safer way is: Run <code>SET lock_timeout = '2s';</code> before the statement and retry the migration if necessary.</p><p>The statement took <code>AccessExclusiveLock</code> on the Table <code>public.books</code> without a timeout. It blocks <code>SELECT</code>, <code>FOR UPDATE</code>, <code>FOR NO KEY UPDATE</code>, <code>FOR SHARE</code>, <code>FOR KEY SHARE</code>, <code>UPDATE</code>, <code>DELETE</code>, <code>INSERT</code>, <code>MERGE</code> while waiting to acquire the lock.</p><h2 id=statement-number-2-for-10-ms>Statement number 2 for 10 ms<a hidden class=anchor aria-hidden=true href=#statement-number-2-for-10-ms>#</a></h2><h3 id=sql-1>SQL<a hidden class=anchor aria-hidden=true href=#sql-1>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>alter</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>books</span><span class=w> </span><span class=k>add</span><span class=w> </span><span class=k>constraint</span><span class=w> </span><span class=n>title_unique</span><span class=w> </span><span class=k>unique</span><span class=w> </span><span class=p>(</span><span class=n>title</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><h3 id=locks-at-start-1>Locks at start<a hidden class=anchor aria-hidden=true href=#locks-at-start-1>#</a></h3><table><thead><tr><th>Schema</th><th>Object</th><th>Mode</th><th>Relkind</th><th>OID</th><th>Safe</th></tr></thead><tbody><tr><td><code>public</code></td><td><code>books</code></td><td><code>AccessExclusiveLock</code></td><td>Table</td><td>1</td><td>❌</td></tr></tbody></table><h3 id=new-locks-taken-1>New locks taken<a hidden class=anchor aria-hidden=true href=#new-locks-taken-1>#</a></h3><table><thead><tr><th>Schema</th><th>Object</th><th>Mode</th><th>Relkind</th><th>OID</th><th>Safe</th></tr></thead><tbody><tr><td><code>public</code></td><td><code>books</code></td><td><code>ShareLock</code></td><td>Table</td><td>1</td><td>❌</td></tr></tbody></table><h3 id=hints-1>Hints<a hidden class=anchor aria-hidden=true href=#hints-1>#</a></h3><h4 id=running-more-statements-after-taking-accessexclusivelock>Running more statements after taking <code>AccessExclusiveLock</code><a hidden class=anchor aria-hidden=true href=#running-more-statements-after-taking-accessexclusivelock>#</a></h4><p>ID: <code>holding_access_exclusive</code></p><p>A transaction that holds an <code>AccessExclusiveLock</code> started a new statement. This blocks all access to the table for the duration of this statement. A safer way is: Run this statement in a new transaction.</p><p>The statement is running while holding an <code>AccessExclusiveLock</code> on the Table <code>public.books</code>, blocking all other transactions from accessing it.</p><h4 id=creating-a-new-index-on-an-existing-table>Creating a new index on an existing table<a hidden class=anchor aria-hidden=true href=#creating-a-new-index-on-an-existing-table>#</a></h4><p>ID: <code>new_index_on_existing_table_is_nonconcurrent</code></p><p>A new index was created on an existing table without the <code>CONCURRENTLY</code> keyword. This blocks all writes to the table while the index is being created. A safer way is: Run <code>CREATE INDEX CONCURRENTLY</code> instead of <code>CREATE INDEX</code>.</p><p>A new index was created on the table <code>public.books</code>. The index <code>public.title_unique</code> was created non-concurrently, which blocks all writes to the table. Use <code>CREATE INDEX CONCURRENTLY</code> to avoid blocking writes.</p><h4 id=creating-a-new-unique-constraint>Creating a new unique constraint<a hidden class=anchor aria-hidden=true href=#creating-a-new-unique-constraint>#</a></h4><p>ID: <code>new_unique_constraint_created_index</code></p><p>Found a new unique constraint and a new index. This blocks all writes to the table while the index is being created and validated. A safer way is: <code>CREATE UNIQUE INDEX CONCURRENTLY</code>, then add the constraint using the index.</p><p>A new unique constraint <code>title_unique</code> was added to the table <code>public.books</code>. This constraint creates a unique index on the table, and blocks all writes. Consider creating the index concurrently in a separate transaction, then adding the unique constraint by using the index: <code>ALTER TABLE public.books ADD CONSTRAINT title_unique UNIQUE USING INDEX public.title_unique;</code></p><h4 id=taking-dangerous-lock-without-timeout-1>Taking dangerous lock without timeout<a hidden class=anchor aria-hidden=true href=#taking-dangerous-lock-without-timeout-1>#</a></h4><p>ID: <code>dangerous_lock_without_timeout</code></p><p>A lock that would block many common operations was taken without a timeout. This can block all other operations on the table indefinitely if any other transaction holds a conflicting lock while <code>idle in transaction</code> or <code>active</code>. A safer way is: Run <code>SET lock_timeout = '2s';</code> before the statement and retry the migration if necessary.</p><p>The statement took <code>ShareLock</code> on the Table <code>public.books</code> without a timeout. It blocks <code>UPDATE</code>, <code>DELETE</code>, <code>INSERT</code>, <code>MERGE</code> while waiting to acquire the lock.</p></div><h1 id=how-to-perform-this-change-safely>How to perform this change safely<a hidden class=anchor aria-hidden=true href=#how-to-perform-this-change-safely>#</a></h1><p><code>eugene</code> has some concrete suggestions for changes we could do to make this migration safer. We should
always use <code>lock_timeout</code> when taking locks, and here&rsquo;s a way to perform this migration in more steps
that causes less time with dangerous locks held overall. The hints give us a strategy to perform the
migration in several more steps:</p><h2 id=step-1-add-a-check-constraint-that-is-not-valid>Step 1: Add a <code>CHECK</code> constraint that is <code>NOT VALID</code><a hidden class=anchor aria-hidden=true href=#step-1-add-a-check-constraint-that-is-not-valid>#</a></h2><p>This still takes the <code>AccessExclusiveLock</code> on <code>books</code>, but it no longer needs to validate all the rows,
so the lock should be held for a shorter time. All inserts or updates on <code>books</code> will only allow
<code>title</code> to be <code>not null</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>set</span><span class=w> </span><span class=n>lock_timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2s&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>alter</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>books</span><span class=w> </span><span class=k>add</span><span class=w> </span><span class=k>constraint</span><span class=w> </span><span class=n>title_not_null</span><span class=w> </span><span class=k>check</span><span class=w> </span><span class=p>(</span><span class=n>title</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>)</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>valid</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h2 id=step-2-validate-the-constraint>Step 2: Validate the constraint<a hidden class=anchor aria-hidden=true href=#step-2-validate-the-constraint>#</a></h2><p>This will take a <code>ShareUpdateExclusiveLock</code> on <code>books</code>, which is less restrictive than
the <code>AccessExclusiveLock</code>. This is possible, because only &ldquo;old rows&rdquo; could possibly be
<code>null</code>, so there&rsquo;s no need to guard against inserts or updates with a lock.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>set</span><span class=w> </span><span class=n>lock_timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2s&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>alter</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>books</span><span class=w> </span><span class=n>validate</span><span class=w> </span><span class=k>constraint</span><span class=w> </span><span class=n>title_not_null</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h2 id=step-3-make-the-column-not-null>Step 3: Make the column <code>not null</code><a hidden class=anchor aria-hidden=true href=#step-3-make-the-column-not-null>#</a></h2><p>At this point, postgres already knows that <code>title</code> is not null, so the <code>AccessExclusiveLock</code> is
only necessary for updating the catalog, which is instant:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>set</span><span class=w> </span><span class=n>lock_timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2s&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>alter</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>books</span><span class=w> </span><span class=k>alter</span><span class=w> </span><span class=k>column</span><span class=w> </span><span class=n>title</span><span class=w> </span><span class=k>set</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h2 id=step-4-add-the-unique-constraint-concurrently>Step 4: Add the unique constraint concurrently<a hidden class=anchor aria-hidden=true href=#step-4-add-the-unique-constraint-concurrently>#</a></h2><p>This returns immediately, and postgres will build up the index and validate the constraint
in its own time, generally without blocking other operations:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>unique</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=n>concurrently</span><span class=w> </span><span class=n>title_unique_idx</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>books</span><span class=p>(</span><span class=n>title</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><h2 id=step-5-add-the-unique-constraint-using-the-index>Step 5: Add the unique constraint using the index<a hidden class=anchor aria-hidden=true href=#step-5-add-the-unique-constraint-using-the-index>#</a></h2><p>This is also instant now, since the index is already built and postgres knows that <code>title</code> is unique.
The <code>AccessExclusiveLock</code> is again only necessary for updating the catalog:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>set</span><span class=w> </span><span class=n>lock_timeout</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;2s&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>alter</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>books</span><span class=w> </span><span class=k>add</span><span class=w> </span><span class=k>constraint</span><span class=w> </span><span class=n>title_unique</span><span class=w> </span><span class=k>unique</span><span class=w> </span><span class=k>using</span><span class=w> </span><span class=k>index</span><span class=w> </span><span class=n>title_unique_idx</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h2><p>In this instance, <code>eugene</code> was able to provide some valuable hints about how to make migrations
that achieve the same result, but is much less likely to cause disturbances in the database.</p><p>There are many example migration scripts and reports like this in the
<a href=https://github.com/kaaveland/eugene/blob/main/examples/>examples</a> directory of the repository.</p><h2 id=when-do-you-need-a-tool-like-eugene>When do you need a tool like <code>eugene</code>?<a hidden class=anchor aria-hidden=true href=#when-do-you-need-a-tool-like-eugene>#</a></h2><p>Breaking small database changes into this many steps isn&rsquo;t for everyone. I have worked on many
systems where we did migrations all the time without using safeguards like this, and most of
the time, it was fine. In many cases, some amount of downtime was acceptable and we could stop
the application prior to running DDL. In many other cases, <code>lock_timeout</code> alone would have
saved us from issues with slow concurrent transactions and lock queues.</p><p>There is a lot of value in simplicity and simple migration scripts if you can afford it. Here
are some things you may need to deal with if you use the safer approach recommended by
eugene:</p><ul><li>If your statements are unable to take their locks in 2 seconds, your script crashes. You
may need retries around your migration deployment.</li><li>Creating indexes concurrently can take a long time. The statement returns right away
and you need to wait for it to finish before you can run the next migration. You must be
prepared to handle a deadlock or unique violation that makes it unable to complete
the index.</li><li>Invariably, working like this is going to make you create a lot more migration scripts
than you otherwise would have.</li></ul><p>But if you&rsquo;d like to learn more about how postgres locking works, and how to avoid common pitfalls
when doing migrations, <code>eugene</code> can be a valuable tool. If you&rsquo;re working on a system where
some tables are very large, or have a lot of concurrent transactions where some are slow, <code>eugene</code>
could help you avoid &ldquo;stopping the world&rdquo; in production when you&rsquo;re executing migrations.</p><p>On the whole, I&rsquo;ve certainly learned a lot about how postgres works while making <code>eugene</code>,
and I hope that I can impart some of that learning on others by seeing the tool adopted.</p><h1 id=how-does-eugene-trace-work>How does <code>eugene trace</code> work?<a hidden class=anchor aria-hidden=true href=#how-does-eugene-trace-work>#</a></h1><p><code>eugene</code> has a lot of static data built into it. For example:</p><ul><li>It knows about which lock modes that conflict with each other, I&rsquo;ve lifted this from the
excellent <a href=https://www.postgresql.org/docs/current/explicit-locking.html>postgres documentation</a>
about locks.</li><li>It has lots of helpful text snippets that can be used to generate hints. I&rsquo;ve lifted many of
these from the awesome <a href=https://github.com/ankane/strong_migrations>strong_migrations</a> README.</li></ul><p>But the primary mechanism that it uses is to break down the SQL script into individual
statements, that are then run in a transaction. Before and after each statement, important
database state is saved in memory, which enables us to calculate the effect that the statement
had on several important system views in the database:</p><ul><li><code>pg_class</code> helps eugene figure out which database objects that are <em>visible</em> to other transactions (and maybe in the future, which objects that have been rewritten).</li><li><code>pg_locks</code> helps eugene figure out which locks that it owns</li><li><code>pg_attribute</code> helps eugene figure out which schema changes that were made to tables</li><li><code>pg_constraint</code> helps eugene figure out which constraints that were added, altered or removed</li></ul><p>This means that there&rsquo;s a lot of knowledge that <code>eugene</code> does <em>not</em> need to have, for example, it does
not need a very good SQL parser, or keep track of which versions of postgres that exhibits what behaviour.
If postgres 17 will be able to add constraints with lesser locks, <code>eugene</code> will be able to figure that out.</p><p>Running the transaction, then optionally committing it results in a big data structure that essentially is
a layered diff of database state. <code>eugene trace -f json</code> can emit this structure, so that it could be used
by tools like <code>jq</code>, or <code>eugene trace -f md</code> can generate a markdown report like the one above. Both of
these are essentially just views of this layered diff.</p><h2 id=how-are-hints-implemented>How are hints implemented?<a hidden class=anchor aria-hidden=true href=#how-are-hints-implemented>#</a></h2><p>It is easy to add new hints to <code>eugene</code>. They consist of a lot of static text, and then a rule that
checks a statement level diff for certain conditions. If the conditions are met, the hint is emitted.
Here&rsquo;s an example of a hint rule for the <code>running_statement_while_holding_access_exclusive</code> hint:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=k>fn</span> <span class=nf>running_statement_while_holding_access_exclusive</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sql_statement_trace</span>: <span class=kp>&amp;</span><span class=nc>FullSqlStatementLockTrace</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Option</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>lock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sql_statement_trace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>locks_at_start</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>iter</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=o>|</span><span class=n>lock</span><span class=o>|</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=n>mode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&#34;AccessExclusiveLock&#34;</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>help</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>format!</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=s>&#34;The statement is running while holding an `AccessExclusiveLock` on the </span><span class=si>{}</span><span class=s> `</span><span class=si>{}</span><span class=s>.</span><span class=si>{}</span><span class=s>`, </span><span class=se>\</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>                blocking all other transactions from accessing it.&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>lock</span><span class=p>.</span><span class=n>relkind</span><span class=p>,</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=n>schema</span><span class=p>,</span><span class=w> </span><span class=n>lock</span><span class=p>.</span><span class=n>object_name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Some</span><span class=p>(</span><span class=n>help</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>Here&rsquo;s another one for discovering columns that changed from <code>NULL</code> to <code>NOT NULL</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-rust data-lang=rust><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>fn</span> <span class=nf>make_column_not_nullable_help</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>sql_statement_trace</span>: <span class=kp>&amp;</span><span class=nc>FullSqlStatementLockTrace</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Option</span><span class=o>&lt;</span><span class=nb>String</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>column</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sql_statement_trace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>altered_columns</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>iter</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>.</span><span class=n>find</span><span class=p>(</span><span class=o>|</span><span class=n>column</span><span class=o>|</span><span class=w> </span><span class=o>!</span><span class=n>column</span><span class=p>.</span><span class=n>new</span><span class=p>.</span><span class=n>nullable</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>column</span><span class=p>.</span><span class=n>old</span><span class=p>.</span><span class=n>nullable</span><span class=p>)</span><span class=o>?</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>table_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>format!</span><span class=p>(</span><span class=s>&#34;</span><span class=si>{}</span><span class=s>.</span><span class=si>{}</span><span class=s>&#34;</span><span class=p>,</span><span class=w> </span><span class=n>column</span><span class=p>.</span><span class=n>new</span><span class=p>.</span><span class=n>schema_name</span><span class=p>,</span><span class=w> </span><span class=n>column</span><span class=p>.</span><span class=n>new</span><span class=p>.</span><span class=n>table_name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>col_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>column</span><span class=p>.</span><span class=n>new</span><span class=p>.</span><span class=n>column_name</span><span class=p>.</span><span class=n>as_str</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>help</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>format!</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;The column `</span><span class=si>{col_name}</span><span class=s>` in the table `</span><span class=si>{table_name}</span><span class=s>` was changed to `NOT NULL`. </span><span class=se>\</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>            If there is a `CHECK (</span><span class=si>{col_name}</span><span class=s> IS NOT NULL)` constraint on `</span><span class=si>{table_name}</span><span class=s>`, this is safe. </span><span class=se>\</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>            Splitting this kind of change into 3 steps can make it safe:</span><span class=se>\n\n\</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>            1. Add a `CHECK (</span><span class=si>{col_name}</span><span class=s> IS NOT NULL) NOT VALID;` constraint on `</span><span class=si>{table_name}</span><span class=s>`.</span><span class=se>\n\</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>            2. Validate the constraint in a later transaction, with `ALTER TABLE </span><span class=si>{table_name}</span><span class=s> VALIDATE CONSTRAINT ...`.</span><span class=se>\n\</span><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>            3. Make the column `NOT NULL`</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nb>Some</span><span class=p>(</span><span class=n>help</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>I am hoping for some help to add many more to <a href=https://github.com/kaaveland/eugene/blob/main/src/hints.rs>hints.rs</a>
in the future, I am certain that there are many kinds of migration patterns that I do not know about. If you install
the tool, you can run <code>eugene hints</code> to display general information about the hints that it knows about, for example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;hints&#34;</span><span class=o>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;id&#34;</span><span class=o>:</span> <span class=s2>&#34;validate_constraint_with_lock&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;name&#34;</span><span class=o>:</span> <span class=s2>&#34;Validating table with a new constraint&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;condition&#34;</span><span class=o>:</span> <span class=s2>&#34;A new constraint was added and it is already `VALID`&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;effect&#34;</span><span class=o>:</span> <span class=s2>&#34;This blocks all table access until all rows are validated&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=s2>&#34;workaround&#34;</span><span class=o>:</span> <span class=s2>&#34;Add the constraint as `NOT VALID` and validate it with `ALTER TABLE ... VALIDATE CONSTRAINT` later&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=c1>// and many more
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h1 id=where-to-get-eugene>Where to get <code>eugene</code><a hidden class=anchor aria-hidden=true href=#where-to-get-eugene>#</a></h1><p>You can install <code>eugene</code> from <a href=https://crates.io/crates/eugene>crates.io</a> using <code>cargo install eugene --bin</code>,
or you can use the docker image <code>ghcr.io/kaaveland/eugene</code> to run the tool. I have been trying to document
it well in the <a href=https://github.com/kaaveland/eugene>github repository</a>. If you want to play around with
it, I suggest you clone the repository. There is a <code>docker-compose.yml</code> that boots up a postgres database
which is compatible with the example migrations in <code>examples/</code>, so this should get you started:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>docker-compose up -d <span class=c1># boots postgres on 5432</span>
</span></span><span class=line><span class=cl>cargo run trace -f markdown examples/alter_column_not_null.sql <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  glow <span class=c1># glow renders markdown in the terminal beautifully</span>
</span></span></code></pre></div><p>If you make any changes to the source code, you can run <code>cargo test</code> to run the tests, and see
the diff on all of the markdown files in <code>examples/</code> to see the effect of your change.</p><p>The test setup is using another neat postgres trick from
<a href=/isolating-integration-tests-that-commit-transactions.html>this blog</a> to make sure that the tests
can run DDL changes in parallel without conflicting with each other or causing deadlocks.</p><p>Once you&rsquo;re satisfied with your changes, you can run <code>cargo install --path . --bin</code> to install the
the tool to your system and try it out on your own migrations.</p><h1 id=future-work>Future work<a hidden class=anchor aria-hidden=true href=#future-work>#</a></h1><p>I have a lot of ideas for how to improve <code>eugene</code>. Here are some of them:</p><ul><li>Add more hints. I am hoping for ideas on the <a href=https://github.com/kaaveland/eugene/issues>issue tracker</a></li><li>Read and parse <code>pg_stat_statements</code> to find out which queries that could conflict with migrations.</li><li>Add a <code>eugene ci</code> command that is suitable for integration with CI/CD pipelines, like pull requests
so that you can run <code>eugene ci</code> on a branch and get a report on the pull request.</li><li>Adding mechanisms to make <code>eugene</code> work like a linter, so it can optionally &ldquo;fail the build&rdquo;.</li><li>Add detection of table and index rewrites, so <code>eugene</code> can tell you if a migration could take an
unexpectedly long time.</li><li>Automatically generate safer migration scripts where it is possible to do this in a deterministic
manner.</li></ul><p>I am hoping to get some feedback on the tool, and I would love some suggestions on the issue tracker for
where to go from here.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://kaveland.no/tags/postgres/>Postgres</a></li><li><a href=https://kaveland.no/tags/rust/>Rust</a></li><li><a href=https://kaveland.no/tags/eugene/>Eugene</a></li></ul><nav class=paginav><a class=prev href=https://kaveland.no/posts/2024-05-16-porting-from-cats-effects-to-zio/><span class=title>« Prev</span><br><span>Porting an application from cats effects to ZIO</span>
</a><a class=next href=https://kaveland.no/posts/2024-04-12-careful-with-that-lock-eugene/><span class=title>Next »</span><br><span>Careful with That Lock, Eugene</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Careful with That Lock, Eugene: Part 2 on x" href="https://x.com/intent/tweet/?text=Careful%20with%20That%20Lock%2c%20Eugene%3a%20Part%202&amp;url=https%3a%2f%2fkaveland.no%2fposts%2f2024-05-06-careful-with-that-lock-eugene-pt-2%2f&amp;hashtags=postgres%2crust%2ceugene"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Careful with That Lock, Eugene: Part 2 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fkaveland.no%2fposts%2f2024-05-06-careful-with-that-lock-eugene-pt-2%2f&amp;title=Careful%20with%20That%20Lock%2c%20Eugene%3a%20Part%202&amp;summary=Careful%20with%20That%20Lock%2c%20Eugene%3a%20Part%202&amp;source=https%3a%2f%2fkaveland.no%2fposts%2f2024-05-06-careful-with-that-lock-eugene-pt-2%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Careful with That Lock, Eugene: Part 2 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fkaveland.no%2fposts%2f2024-05-06-careful-with-that-lock-eugene-pt-2%2f&title=Careful%20with%20That%20Lock%2c%20Eugene%3a%20Part%202"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Careful with That Lock, Eugene: Part 2 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fkaveland.no%2fposts%2f2024-05-06-careful-with-that-lock-eugene-pt-2%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Careful with That Lock, Eugene: Part 2 on whatsapp" href="https://api.whatsapp.com/send?text=Careful%20with%20That%20Lock%2c%20Eugene%3a%20Part%202%20-%20https%3a%2f%2fkaveland.no%2fposts%2f2024-05-06-careful-with-that-lock-eugene-pt-2%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Careful with That Lock, Eugene: Part 2 on telegram" href="https://telegram.me/share/url?text=Careful%20with%20That%20Lock%2c%20Eugene%3a%20Part%202&amp;url=https%3a%2f%2fkaveland.no%2fposts%2f2024-05-06-careful-with-that-lock-eugene-pt-2%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Careful with That Lock, Eugene: Part 2 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Careful%20with%20That%20Lock%2c%20Eugene%3a%20Part%202&u=https%3a%2f%2fkaveland.no%2fposts%2f2024-05-06-careful-with-that-lock-eugene-pt-2%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://kaveland.no/>Robin's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>