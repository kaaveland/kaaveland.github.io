<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Finding foreign keys missing indexes | Robin's blog</title>
<meta name=keywords content="postgres,sql"><meta name=description content="Last week I was made aware that we had some foreign keys not backed by indexes in the system we&rsquo;re developing at work. Foreign keys in postgres must be backed by an index only on the side they refer to, not necessarily the side they refer from. Here&rsquo;s an example:
create table author(
    id bigint generated always as identity primary key,
    name text not null
);

create table book(
    id bigint generated always as identity primary key,
    author bigint not null references author(id),
    title text not null
);
In this example, there&rsquo;s a foreign key from the book table to the author table. Since author refers to a primary key in the author table, inserts into book can validate very quickly. There&rsquo;s no index on the author column in the book table though. The consequence of this is that delete on author must check every single row in book to check if it&rsquo;s safe to actually delete. The really annoying part of this is that the scan does not show up in query plans:"><meta name=author content="Robin Kåveland"><link rel=canonical href=https://kaveland.no/posts/2025-04-04-finding-missing-indexes-in-pg-catalog/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://kaveland.no/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kaveland.no/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kaveland.no/favicon-32x32.png><link rel=apple-touch-icon href=https://kaveland.no/apple-touch-icon.png><link rel=mask-icon href=https://kaveland.no/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kaveland.no/posts/2025-04-04-finding-missing-indexes-in-pg-catalog/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer data-domain=kaveland.no src=https://plausible.io/js/script.js></script><meta property="og:title" content="Finding foreign keys missing indexes"><meta property="og:description" content="Last week I was made aware that we had some foreign keys not backed by indexes in the system we&rsquo;re developing at work. Foreign keys in postgres must be backed by an index only on the side they refer to, not necessarily the side they refer from. Here&rsquo;s an example:
create table author(
    id bigint generated always as identity primary key,
    name text not null
);

create table book(
    id bigint generated always as identity primary key,
    author bigint not null references author(id),
    title text not null
);
In this example, there&rsquo;s a foreign key from the book table to the author table. Since author refers to a primary key in the author table, inserts into book can validate very quickly. There&rsquo;s no index on the author column in the book table though. The consequence of this is that delete on author must check every single row in book to check if it&rsquo;s safe to actually delete. The really annoying part of this is that the scan does not show up in query plans:"><meta property="og:type" content="article"><meta property="og:url" content="https://kaveland.no/posts/2025-04-04-finding-missing-indexes-in-pg-catalog/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-04T00:00:00+00:00"><meta property="article:modified_time" content="2025-04-04T00:00:00+00:00"><meta property="og:site_name" content="Robin's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Finding foreign keys missing indexes"><meta name=twitter:description content="Last week I was made aware that we had some foreign keys not backed by indexes in the system we&rsquo;re developing at work. Foreign keys in postgres must be backed by an index only on the side they refer to, not necessarily the side they refer from. Here&rsquo;s an example:
create table author(
    id bigint generated always as identity primary key,
    name text not null
);

create table book(
    id bigint generated always as identity primary key,
    author bigint not null references author(id),
    title text not null
);
In this example, there&rsquo;s a foreign key from the book table to the author table. Since author refers to a primary key in the author table, inserts into book can validate very quickly. There&rsquo;s no index on the author column in the book table though. The consequence of this is that delete on author must check every single row in book to check if it&rsquo;s safe to actually delete. The really annoying part of this is that the scan does not show up in query plans:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kaveland.no/posts/"},{"@type":"ListItem","position":2,"name":"Finding foreign keys missing indexes","item":"https://kaveland.no/posts/2025-04-04-finding-missing-indexes-in-pg-catalog/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Finding foreign keys missing indexes","name":"Finding foreign keys missing indexes","description":"Last week I was made aware that we had some foreign keys not backed by indexes in the system we\u0026rsquo;re developing at work. Foreign keys in postgres must be backed by an index only on the side they refer to, not necessarily the side they refer from. Here\u0026rsquo;s an example:\ncreate table author( id bigint generated always as identity primary key, name text not null ); create table book( id bigint generated always as identity primary key, author bigint not null references author(id), title text not null ); In this example, there\u0026rsquo;s a foreign key from the book table to the author table. Since author refers to a primary key in the author table, inserts into book can validate very quickly. There\u0026rsquo;s no index on the author column in the book table though. The consequence of this is that delete on author must check every single row in book to check if it\u0026rsquo;s safe to actually delete. The really annoying part of this is that the scan does not show up in query plans:\n","keywords":["postgres","sql"],"articleBody":"Last week I was made aware that we had some foreign keys not backed by indexes in the system we’re developing at work. Foreign keys in postgres must be backed by an index only on the side they refer to, not necessarily the side they refer from. Here’s an example:\ncreate table author( id bigint generated always as identity primary key, name text not null ); create table book( id bigint generated always as identity primary key, author bigint not null references author(id), title text not null ); In this example, there’s a foreign key from the book table to the author table. Since author refers to a primary key in the author table, inserts into book can validate very quickly. There’s no index on the author column in the book table though. The consequence of this is that delete on author must check every single row in book to check if it’s safe to actually delete. The really annoying part of this is that the scan does not show up in query plans:\npostgres=# insert into author(name) values ('Robin Hobb'); INSERT 0 1 postgres=# insert into book(author, title) values (1, 'Fool''s Quest'); INSERT 0 1 postgres=# explain analyze delete from author where id = 1337; QUERY PLAN -------------------------------------------------------------------------------------------------------------------------- Delete on author (cost=0.15..8.17 rows=0 width=0) (actual time=0.180..0.181 rows=0 loops=1) -\u003e Index Scan using author_pkey on author (cost=0.15..8.17 rows=1 width=6) (actual time=0.174..0.175 rows=0 loops=1) Index Cond: (id = 1337) Planning Time: 0.265 ms Execution Time: 0.321 ms (5 rows) This query plan looks fine at a glance. It does not show the extra work that is necessary to validate referential integrity. It’s easy to miss this problem when the load in production is sky-high and things aren’t working. Since it can be challenging to predict how systems grow and change over time, it is often better to use some extra disk space and a few microseconds on insertion time to maintain an index. You’ll never know the index is there, but at some poorly timed day in the future, you’ll notice if it’s not. If the index is never needed because the table never grows big, it’s also an inexpensive index that stays small.\nWorking with pg_catalog to identify missing indexes pg_catalog is a rich collection of system tables and views that we can inspect to learn things about the current database. We can easily retrieve the foreign keys in the current database by looking in pg_constraint:\npostgres=# select conname, conrelid, conkey from pg_constraint where contype = 'f'; conname | conrelid | conkey ------------------+----------+-------- book_author_fkey | 204852 | {2} (1 row) Here, contype = 'f' asks for foreign keys, conname is the foreign key name, conrelid is the id of the table that “owns” the foreign key constraint and conkey is a collection of columns the constraint uses. We can look up the columns in pg_attribute:\npostgres=# select attnum, attname from pg_attribute where attrelid = 204852; attnum | attname --------+---------- -6 | tableoid -5 | cmax -4 | xmax -3 | cmin -2 | xmin -1 | ctid 1 | id 2 | author 3 | title (9 rows) The attnum column goes with the conkey column, and there’s a bunch of hidden columns with negative identifiers for the table too. As an aside, we can select those if we want to:\npostgres=# select tableoid, xmin from book; tableoid | xmin ----------+------- 204852 | 11038 (1 row) But we normally don’t need to know about them. Anyway, it is easy enough to collect all the column names used by a foreign key by inspecting these two system catalogs. For index information, we can consult pg_index. Let’s look up the index information for the book table:\npostgres=# select indexrelid, indkey postgres-# from pg_index where indrelid = 204852 and indisvalid and indpred is null; indexrelid | indkey ------------+-------- 204857 | 1 (1 row) indexrelid is the system id of the index itself (helpful for finding its name in the pg_class catalog). The indkey column is a collection of columns the index refers to. We do some filtering here, if indpred is not null it means that the index is a partial index which may not be good enough for a foreign key.\nComposite foreign keys Note how pg_constraint.conkey and pg_index.indkey are both collections of column identifiers. That’s because both foreign keys and indexes can contain many columns. Let’s complicate matters a little bit to illustrate, by pretending we have some natural keys that consist of many parts.\ncreate table country( id bigint generated always as identity primary key, country_code text not null ); create table organization( name text not null, country bigint not null, primary key(name, country), foreign key(country) references country(id) ); create table account( country bigint not null, organization text not null, email_id bigint not null, name text not null, primary key(country, organization, email_id), foreign key(country) references country(id), foreign key(country, organization) references organization(country, name) ); Now we get these foreign keys:\npostgres=# select conname, conrelid, conkey from pg_constraint where contype = 'f'; conname | conrelid | conkey -----------------------------------+----------+-------- book_author_fkey | 204852 | {2} organization_country_fkey | 204890 | {2} account_country_fkey | 204902 | {1} account_country_organization_fkey | 204902 | {1,2} (4 rows) The interesting part here is really that account_country_fkey and account_country_organization_fk can be backed by the same index since they share a prefix ({1}). pg_index looks like this for the account table:\npostgres=# select indexrelid, indkey from pg_index where indrelid = 204902 and indisvalid and indpred is null; indexrelid | indkey ------------+-------- 204907 | 1 2 3 (1 row) So the need for an index here is actually covered already. That’s because the foreign key can use an index as long as it is a prefix of that index. The organization table is different:\npostgres=# select indexrelid, indkey from pg_index where indrelid = 204890 and indisvalid and indpred is null; indexrelid | indkey ------------+-------- 204895 | 1 2 (1 row) This needs an index, because the index does not start with the same column as the foreign key. To summarize, we currently lack these indexes:\nThe author column of the book table The country column of the organization table There’s just one little thing we need to know to write the query that connects pg_constraint and pg_index in the right way now – pg_index.indkey and pg_constraint.conkey are both 0-indexed collections. This runs counter to intuition since arrays are normally 1-indexed in postgres.\nConnecting pg_constraint and pg_index We want to do an anti-join – we want to keep the pg_constraint columns that are not matched by any row in pg_index. Let’s break the query down with CTEs so it’s manageable to look at:\nwith fks as ( select conname, conrelid, conkey :: smallint[] from pg_constraint where contype = 'f' ), indexes as ( select indrelid, indkey :: smallint[] from pg_index where indpred is null and indisvalid ) select fks.conname, fks.conrelid, fks.conkey from fks left join indexes on fks.conrelid = indexes.indrelid and -- foreign key must be prefix of index and both arrays are 0-indexed fks.conkey = indexes.indkey[0:array_length(fks.conkey, 1) - 1] where indexes.indrelid is null; -- no index found Running this gives us the expected two foreign keys:\nconname | conrelid | conkey ---------------------------+----------+-------- organization_country_fkey | 204890 | {2} book_author_fkey | 204852 | {2} (2 rows) Drawing the rest of the FK-ing owl But this leaves a lot of work left for whoever is using the output. We can use pg_class to fetch the table name, pg_namespace to fetch the schema name and pg_attributes to get the column names to make it a little nicer to look at the output. Let’s get to work:\nwith fks as ( select conname, conrelid, conkey :: smallint[] from pg_constraint where contype = 'f' ), indexes as ( select indrelid, indkey :: smallint[] from pg_index where indpred is null and indisvalid ), fks_without_index as ( select fks.conname, fks.conrelid, fks.conkey from fks left join indexes on fks.conrelid = indexes.indrelid and -- foreign key must be prefix of index and both arrays are 0-indexed fks.conkey = indexes.indkey[0:array_length(fks.conkey, 1) - 1] where indexes.indrelid is null -- no index found ) select pg_namespace.nspname as schema_name, pg_class.relname as table_name, fk.conname as fk, array_agg( pg_attribute.attname -- order the column names by their position in the foreign key order by array_position(fk.conkey, pg_attribute.attnum) ) as columns from fks_without_index fk join pg_class on fk.conrelid = pg_class.oid join pg_namespace on pg_class.relnamespace = pg_namespace.oid join pg_attribute on fk.conrelid = pg_attribute.attrelid and pg_attribute.attnum = any(fk.conkey) group by schema_name, table_name, fk; This gives us a nice output that is straightforward to look at, and we could also easily generate create index statements for the columns now:\nschema_name | table_name | fk | columns -------------+--------------+---------------------------+----------- public | book | book_author_fkey | {author} public | organization | organization_country_fkey | {country} (2 rows) Put it in CI and create the indexes it suggests, and it’ll save you trouble and stress in the future.\n","wordCount":"1468","inLanguage":"en","datePublished":"2025-04-04T00:00:00Z","dateModified":"2025-04-04T00:00:00Z","author":{"@type":"Person","name":"Robin Kåveland"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kaveland.no/posts/2025-04-04-finding-missing-indexes-in-pg-catalog/"},"publisher":{"@type":"Organization","name":"Robin's blog","logo":{"@type":"ImageObject","url":"https://kaveland.no/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kaveland.no/ accesskey=h title="Robin's blog (Alt + H)">Robin's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kaveland.no/about/ title=about><span>about</span></a></li><li><a href=https://kaveland.no/projects/ title=projects><span>projects</span></a></li><li><a href=https://kaveland.no/eugene/ title=eugene><span>eugene</span></a></li><li><a href=https://kaveland.no/thumper/ title=thumper><span>thumper</span></a></li><li><a href=https://kaveland.no/tags/ title=tags><span>tags</span></a></li><li><a href=https://kaveland.no/archives/ title=archives><span>archives</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kaveland.no/>Home</a>&nbsp;»&nbsp;<a href=https://kaveland.no/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Finding foreign keys missing indexes</h1><div class=post-meta><span title='2025-04-04 00:00:00 +0000 UTC'>April 4, 2025</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;1468 words&nbsp;·&nbsp;Robin Kåveland&nbsp;|&nbsp;<a href=https://github.com/kaaveland/kaaveland.github.io/content/posts/2025-04-04-finding-missing-indexes-in-pg-catalog.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#working-with-pg_catalog-to-identify-missing-indexes>Working with <code>pg_catalog</code> to identify missing indexes</a></li><li><a href=#composite-foreign-keys>Composite foreign keys</a></li><li><a href=#connecting-pg_constraint-and-pg_index>Connecting <code>pg_constraint</code> and <code>pg_index</code></a></li><li><a href=#drawing-the-rest-of-the-fk-ing-owl>Drawing the rest of the FK-ing owl</a></li></ul></nav></div></details></div><div class=post-content><p>Last week I was made aware that we had some foreign keys not backed by indexes in the system we&rsquo;re developing at work. Foreign keys in postgres must be backed by an index only on the side they refer <em>to</em>, not necessarily the side they refer <em>from</em>. Here&rsquo;s an example:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>author</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>bigint</span><span class=w> </span><span class=k>generated</span><span class=w> </span><span class=n>always</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>identity</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>book</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>bigint</span><span class=w> </span><span class=k>generated</span><span class=w> </span><span class=n>always</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>identity</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>author</span><span class=w> </span><span class=nb>bigint</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>references</span><span class=w> </span><span class=n>author</span><span class=p>(</span><span class=n>id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>title</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>In this example, there&rsquo;s a foreign key from the <code>book</code> table to the <code>author</code> table. Since <code>author</code> refers to a primary key in the <code>author</code> table, inserts into <code>book</code> can validate very quickly. There&rsquo;s no index on the <code>author</code> column in the <code>book</code> table though. The consequence of this is that <code>delete</code> on <code>author</code> must check every single row in <code>book</code> to check if it&rsquo;s safe to actually delete. The really annoying part of this is that the scan does not show up in query plans:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>author</span><span class=p>(</span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;Robin Hobb&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>book</span><span class=p>(</span><span class=n>author</span><span class=p>,</span><span class=w> </span><span class=n>title</span><span class=p>)</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;Fool&#39;&#39;s Quest&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>explain</span><span class=w> </span><span class=k>analyze</span><span class=w> </span><span class=k>delete</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>author</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1337</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>QUERY</span><span class=w> </span><span class=n>PLAN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--------------------------------------------------------------------------------------------------------------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>Delete</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>author</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>15</span><span class=p>..</span><span class=mi>8</span><span class=p>.</span><span class=mi>17</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>0</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>180</span><span class=p>..</span><span class=mi>0</span><span class=p>.</span><span class=mi>181</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>0</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>-&gt;</span><span class=w>  </span><span class=k>Index</span><span class=w> </span><span class=n>Scan</span><span class=w> </span><span class=k>using</span><span class=w> </span><span class=n>author_pkey</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>author</span><span class=w>  </span><span class=p>(</span><span class=n>cost</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>15</span><span class=p>..</span><span class=mi>8</span><span class=p>.</span><span class=mi>17</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>1</span><span class=w> </span><span class=n>width</span><span class=o>=</span><span class=mi>6</span><span class=p>)</span><span class=w> </span><span class=p>(</span><span class=n>actual</span><span class=w> </span><span class=n>time</span><span class=o>=</span><span class=mi>0</span><span class=p>.</span><span class=mi>174</span><span class=p>..</span><span class=mi>0</span><span class=p>.</span><span class=mi>175</span><span class=w> </span><span class=k>rows</span><span class=o>=</span><span class=mi>0</span><span class=w> </span><span class=n>loops</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>Index</span><span class=w> </span><span class=n>Cond</span><span class=p>:</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1337</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Planning</span><span class=w> </span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>265</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>Execution</span><span class=w> </span><span class=n>Time</span><span class=p>:</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>321</span><span class=w> </span><span class=n>ms</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>(</span><span class=mi>5</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>This query plan looks fine at a glance. It does not show the extra work that is necessary to validate referential integrity. It&rsquo;s easy to miss this problem when the load in production is sky-high and things aren&rsquo;t working. Since it can be challenging to predict how systems grow and change over time, it is often better to use some extra disk space and a few microseconds on insertion time to maintain an index. You&rsquo;ll never know the index is there, but at some poorly timed day in the future, you&rsquo;ll notice if it&rsquo;s not. If the index is never needed because the table never grows big, it&rsquo;s also an inexpensive index that stays small.</p><h2 id=working-with-pg_catalog-to-identify-missing-indexes>Working with <code>pg_catalog</code> to identify missing indexes<a hidden class=anchor aria-hidden=true href=#working-with-pg_catalog-to-identify-missing-indexes>#</a></h2><p><a href=https://www.postgresql.org/docs/current/catalogs.html>pg_catalog</a> is a rich collection of system tables and views that we can inspect to learn things about the current database. We can easily retrieve the foreign keys in the current database by looking in <a href=https://www.postgresql.org/docs/current/catalog-pg-constraint.html>pg_constraint</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=n>conname</span><span class=p>,</span><span class=w> </span><span class=n>conrelid</span><span class=p>,</span><span class=w> </span><span class=n>conkey</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>pg_constraint</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>contype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;f&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=n>conname</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>conrelid</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>conkey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------------+----------+--------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>book_author_fkey</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=mi>204852</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=err>{</span><span class=mi>2</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>Here, <code>contype = 'f'</code> asks for foreign keys, <code>conname</code> is the foreign key name, <code>conrelid</code> is the id of the table that &ldquo;owns&rdquo; the foreign key constraint and <code>conkey</code> is a collection of columns the constraint uses. We can look up the columns in <a href=https://www.postgresql.org/docs/current/catalog-pg-attribute.html>pg_attribute</a>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=n>attnum</span><span class=p>,</span><span class=w> </span><span class=n>attname</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>pg_attribute</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>attrelid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>204852</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>attnum</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>attname</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--------+----------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>     </span><span class=o>-</span><span class=mi>6</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>tableoid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>-</span><span class=mi>5</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>cmax</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>-</span><span class=mi>4</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>xmax</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>-</span><span class=mi>3</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>cmin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>-</span><span class=mi>2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>xmin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>     </span><span class=o>-</span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>ctid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=mi>2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>author</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=mi>3</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>title</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>9</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>The <code>attnum</code> column goes with the <code>conkey</code> column, and there&rsquo;s a bunch of hidden columns with negative identifiers for the table too. As an aside, we can select those if we want to:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=n>tableoid</span><span class=p>,</span><span class=w> </span><span class=n>xmin</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>book</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>tableoid</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>xmin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----------+-------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>   </span><span class=mi>204852</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>11038</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>But we normally don&rsquo;t need to know about them. Anyway, it is easy enough to collect all the column names used by a foreign key by inspecting these
two system catalogs. For index information, we can consult <a href=https://www.postgresql.org/docs/current/catalog-pg-index.html>pg_index</a>. Let&rsquo;s look up the index information for the book table:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=n>indexrelid</span><span class=p>,</span><span class=w> </span><span class=n>indkey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>postgres</span><span class=o>-#</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>pg_index</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>indrelid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>204852</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>indisvalid</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>indpred</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=k>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>indexrelid</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>indkey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------+--------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>     </span><span class=mi>204857</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p><code>indexrelid</code> is the system id of the index itself (helpful for finding its name in the <code>pg_class</code> catalog). The <code>indkey</code> column is a collection of columns the index refers to. We do some filtering here, if <code>indpred is not null</code> it means that the index is a <a href=https://www.postgresql.org/docs/current/indexes-partial.html>partial index</a> which may not be good enough for a foreign key.</p><h2 id=composite-foreign-keys>Composite foreign keys<a hidden class=anchor aria-hidden=true href=#composite-foreign-keys>#</a></h2><p>Note how <code>pg_constraint.conkey</code> and <code>pg_index.indkey</code> are both collections of column identifiers. That&rsquo;s because both foreign keys and indexes can contain many columns. Let&rsquo;s complicate matters a little bit to illustrate, by pretending we have some natural keys that consist of many parts.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>country</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>id</span><span class=w> </span><span class=nb>bigint</span><span class=w> </span><span class=k>generated</span><span class=w> </span><span class=n>always</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>identity</span><span class=w> </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>country_code</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>organization</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>country</span><span class=w> </span><span class=nb>bigint</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>country</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>foreign</span><span class=w> </span><span class=k>key</span><span class=p>(</span><span class=n>country</span><span class=p>)</span><span class=w> </span><span class=k>references</span><span class=w> </span><span class=n>country</span><span class=p>(</span><span class=n>id</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>create</span><span class=w> </span><span class=k>table</span><span class=w> </span><span class=n>account</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>country</span><span class=w> </span><span class=nb>bigint</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>organization</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>email_id</span><span class=w> </span><span class=nb>bigint</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>name</span><span class=w> </span><span class=nb>text</span><span class=w> </span><span class=k>not</span><span class=w> </span><span class=k>null</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>primary</span><span class=w> </span><span class=k>key</span><span class=p>(</span><span class=n>country</span><span class=p>,</span><span class=w> </span><span class=n>organization</span><span class=p>,</span><span class=w> </span><span class=n>email_id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>foreign</span><span class=w> </span><span class=k>key</span><span class=p>(</span><span class=n>country</span><span class=p>)</span><span class=w> </span><span class=k>references</span><span class=w> </span><span class=n>country</span><span class=p>(</span><span class=n>id</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>foreign</span><span class=w> </span><span class=k>key</span><span class=p>(</span><span class=n>country</span><span class=p>,</span><span class=w> </span><span class=n>organization</span><span class=p>)</span><span class=w> </span><span class=k>references</span><span class=w> </span><span class=n>organization</span><span class=p>(</span><span class=n>country</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>Now we get these foreign keys:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=n>conname</span><span class=p>,</span><span class=w> </span><span class=n>conrelid</span><span class=p>,</span><span class=w> </span><span class=n>conkey</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>pg_constraint</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>contype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;f&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=n>conname</span><span class=w>              </span><span class=o>|</span><span class=w> </span><span class=n>conrelid</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>conkey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-----------------------------------+----------+--------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>book_author_fkey</span><span class=w>                  </span><span class=o>|</span><span class=w>   </span><span class=mi>204852</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=err>{</span><span class=mi>2</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>organization_country_fkey</span><span class=w>         </span><span class=o>|</span><span class=w>   </span><span class=mi>204890</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=err>{</span><span class=mi>2</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>account_country_fkey</span><span class=w>              </span><span class=o>|</span><span class=w>   </span><span class=mi>204902</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=err>{</span><span class=mi>1</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>account_country_organization_fkey</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=mi>204902</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=err>{</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>4</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>The interesting part here is really that <code>account_country_fkey</code> and <code>account_country_organization_fk</code> can be backed by the same index since they share a prefix (<code>{1}</code>). <code>pg_index</code> looks like this for the <code>account</code> table:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=n>indexrelid</span><span class=p>,</span><span class=w> </span><span class=n>indkey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=n>pg_index</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>indrelid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>204902</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>indisvalid</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>indpred</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=k>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>indexrelid</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>indkey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------+--------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>     </span><span class=mi>204907</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=mi>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>So the need for an index here is actually covered already. That&rsquo;s because the foreign key can use an index as long as it is a prefix of that index. The organization table is different:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=n>indexrelid</span><span class=p>,</span><span class=w> </span><span class=n>indkey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=n>pg_index</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>indrelid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>204890</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>indisvalid</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>indpred</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=k>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>indexrelid</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>indkey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>------------+--------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>     </span><span class=mi>204895</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>This needs an index, because the index does not start with the same column as the foreign key. To summarize, we currently lack these indexes:</p><ul><li>The <code>author</code> column of the <code>book</code> table</li><li>The <code>country</code> column of the <code>organization</code> table</li></ul><p>There&rsquo;s just one little thing we need to know to write the query that connects <code>pg_constraint</code> and <code>pg_index</code> in the right way now &ndash; <code>pg_index.indkey</code> and <code>pg_constraint.conkey</code> are both 0-indexed collections. This runs counter to intuition since arrays are normally 1-indexed in postgres.</p><h2 id=connecting-pg_constraint-and-pg_index>Connecting <code>pg_constraint</code> and <code>pg_index</code><a hidden class=anchor aria-hidden=true href=#connecting-pg_constraint-and-pg_index>#</a></h2><p>We want to do an anti-join &ndash; we want to keep the <code>pg_constraint</code> columns that are not matched by any row in <code>pg_index</code>. Let&rsquo;s break the query down with CTEs so it&rsquo;s manageable to look at:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>with</span><span class=w> </span><span class=n>fks</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=n>conname</span><span class=p>,</span><span class=w> </span><span class=n>conrelid</span><span class=p>,</span><span class=w> </span><span class=n>conkey</span><span class=w> </span><span class=p>::</span><span class=w> </span><span class=nb>smallint</span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>from</span><span class=w> </span><span class=n>pg_constraint</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>where</span><span class=w> </span><span class=n>contype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;f&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>),</span><span class=w> </span><span class=n>indexes</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=n>indrelid</span><span class=p>,</span><span class=w> </span><span class=n>indkey</span><span class=w> </span><span class=p>::</span><span class=w> </span><span class=nb>smallint</span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>from</span><span class=w> </span><span class=n>pg_index</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>where</span><span class=w> </span><span class=n>indpred</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>indisvalid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>fks</span><span class=p>.</span><span class=n>conname</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>fks</span><span class=p>.</span><span class=n>conrelid</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>fks</span><span class=p>.</span><span class=n>conkey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=n>fks</span><span class=w> </span><span class=k>left</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=n>indexes</span><span class=w> </span><span class=k>on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>fks</span><span class=p>.</span><span class=n>conrelid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>indexes</span><span class=p>.</span><span class=n>indrelid</span><span class=w> </span><span class=k>and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>-- foreign key must be prefix of index and both arrays are 0-indexed
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>      </span><span class=n>fks</span><span class=p>.</span><span class=n>conkey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>indexes</span><span class=p>.</span><span class=n>indkey</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=n>array_length</span><span class=p>(</span><span class=n>fks</span><span class=p>.</span><span class=n>conkey</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>where</span><span class=w> </span><span class=n>indexes</span><span class=p>.</span><span class=n>indrelid</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=k>null</span><span class=p>;</span><span class=w> </span><span class=c1>-- no index found
</span></span></span></code></pre></div><p>Running this gives us the expected two foreign keys:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=w>          </span><span class=n>conname</span><span class=w>          </span><span class=o>|</span><span class=w> </span><span class=n>conrelid</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>conkey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>---------------------------+----------+--------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>organization_country_fkey</span><span class=w> </span><span class=o>|</span><span class=w>   </span><span class=mi>204890</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=err>{</span><span class=mi>2</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>book_author_fkey</span><span class=w>          </span><span class=o>|</span><span class=w>   </span><span class=mi>204852</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=err>{</span><span class=mi>2</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h2 id=drawing-the-rest-of-the-fk-ing-owl>Drawing the rest of the FK-ing owl<a hidden class=anchor aria-hidden=true href=#drawing-the-rest-of-the-fk-ing-owl>#</a></h2><p>But this leaves a lot of work left for whoever is using the output. We can use <code>pg_class</code> to fetch the table name, <code>pg_namespace</code> to fetch the schema name and <code>pg_attributes</code> to get the column names to make it a little nicer to look at the output. Let&rsquo;s get to work:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>with</span><span class=w> </span><span class=n>fks</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=n>conname</span><span class=p>,</span><span class=w> </span><span class=n>conrelid</span><span class=p>,</span><span class=w> </span><span class=n>conkey</span><span class=w> </span><span class=p>::</span><span class=w> </span><span class=nb>smallint</span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>from</span><span class=w> </span><span class=n>pg_constraint</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>where</span><span class=w> </span><span class=n>contype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;f&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>),</span><span class=w> </span><span class=n>indexes</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=n>indrelid</span><span class=p>,</span><span class=w> </span><span class=n>indkey</span><span class=w> </span><span class=p>::</span><span class=w> </span><span class=nb>smallint</span><span class=p>[]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>from</span><span class=w> </span><span class=n>pg_index</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>where</span><span class=w> </span><span class=n>indpred</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=k>and</span><span class=w> </span><span class=n>indisvalid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>),</span><span class=w> </span><span class=n>fks_without_index</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>select</span><span class=w> </span><span class=n>fks</span><span class=p>.</span><span class=n>conname</span><span class=p>,</span><span class=w> </span><span class=n>fks</span><span class=p>.</span><span class=n>conrelid</span><span class=p>,</span><span class=w> </span><span class=n>fks</span><span class=p>.</span><span class=n>conkey</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>from</span><span class=w> </span><span class=n>fks</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>left</span><span class=w> </span><span class=k>join</span><span class=w> </span><span class=n>indexes</span><span class=w> </span><span class=k>on</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>fks</span><span class=p>.</span><span class=n>conrelid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>indexes</span><span class=p>.</span><span class=n>indrelid</span><span class=w> </span><span class=k>and</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>-- foreign key must be prefix of index and both arrays are 0-indexed
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=n>fks</span><span class=p>.</span><span class=n>conkey</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>indexes</span><span class=p>.</span><span class=n>indkey</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=n>array_length</span><span class=p>(</span><span class=n>fks</span><span class=p>.</span><span class=n>conkey</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>1</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>where</span><span class=w> </span><span class=n>indexes</span><span class=p>.</span><span class=n>indrelid</span><span class=w> </span><span class=k>is</span><span class=w> </span><span class=k>null</span><span class=w> </span><span class=c1>-- no index found
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>)</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>select</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>pg_namespace</span><span class=p>.</span><span class=n>nspname</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>schema_name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>pg_class</span><span class=p>.</span><span class=n>relname</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>table_name</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>fk</span><span class=p>.</span><span class=n>conname</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>fk</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>array_agg</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=n>pg_attribute</span><span class=p>.</span><span class=n>attname</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c1>-- order the column names by their position in the foreign key 
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>      </span><span class=k>order</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>array_position</span><span class=p>(</span><span class=n>fk</span><span class=p>.</span><span class=n>conkey</span><span class=p>,</span><span class=w> </span><span class=n>pg_attribute</span><span class=p>.</span><span class=n>attnum</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>)</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>columns</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>from</span><span class=w> </span><span class=n>fks_without_index</span><span class=w> </span><span class=n>fk</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>join</span><span class=w> </span><span class=n>pg_class</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>fk</span><span class=p>.</span><span class=n>conrelid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pg_class</span><span class=p>.</span><span class=n>oid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>join</span><span class=w> </span><span class=n>pg_namespace</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>pg_class</span><span class=p>.</span><span class=n>relnamespace</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pg_namespace</span><span class=p>.</span><span class=n>oid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>join</span><span class=w> </span><span class=n>pg_attribute</span><span class=w> </span><span class=k>on</span><span class=w> </span><span class=n>fk</span><span class=p>.</span><span class=n>conrelid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pg_attribute</span><span class=p>.</span><span class=n>attrelid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>and</span><span class=w> </span><span class=n>pg_attribute</span><span class=p>.</span><span class=n>attnum</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>any</span><span class=p>(</span><span class=n>fk</span><span class=p>.</span><span class=n>conkey</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>group</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=k>schema_name</span><span class=p>,</span><span class=w> </span><span class=k>table_name</span><span class=p>,</span><span class=w> </span><span class=n>fk</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>This gives us a nice output that is straightforward to look at, and we could also easily generate <code>create index</code> statements for the columns now:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=w> </span><span class=k>schema_name</span><span class=w> </span><span class=o>|</span><span class=w>  </span><span class=k>table_name</span><span class=w>  </span><span class=o>|</span><span class=w>            </span><span class=n>fk</span><span class=w>             </span><span class=o>|</span><span class=w>  </span><span class=n>columns</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-------------+--------------+---------------------------+-----------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=k>public</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>book</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>book_author_fkey</span><span class=w>          </span><span class=o>|</span><span class=w> </span><span class=err>{</span><span class=n>author</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>public</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>organization</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>organization_country_fkey</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=err>{</span><span class=n>country</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>2</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>Put it in CI and create the indexes it suggests, and it&rsquo;ll save you trouble and stress in the future.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://kaveland.no/tags/postgres/>Postgres</a></li><li><a href=https://kaveland.no/tags/sql/>Sql</a></li></ul><nav class=paginav><a class=prev href=https://kaveland.no/posts/2025-04-14-running-containers-on-the-cheap/><span class=title>« Prev</span><br><span>Running containers on no-ops linux in 2025</span>
</a><a class=next href=https://kaveland.no/posts/2025-03-10-mutual-recursion-for-fun-and-profit/><span class=title>Next »</span><br><span>Constraint propagation: Mutual recursion for fun and profit</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Finding foreign keys missing indexes on x" href="https://x.com/intent/tweet/?text=Finding%20foreign%20keys%20missing%20indexes&amp;url=https%3a%2f%2fkaveland.no%2fposts%2f2025-04-04-finding-missing-indexes-in-pg-catalog%2f&amp;hashtags=postgres%2csql"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Finding foreign keys missing indexes on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fkaveland.no%2fposts%2f2025-04-04-finding-missing-indexes-in-pg-catalog%2f&amp;title=Finding%20foreign%20keys%20missing%20indexes&amp;summary=Finding%20foreign%20keys%20missing%20indexes&amp;source=https%3a%2f%2fkaveland.no%2fposts%2f2025-04-04-finding-missing-indexes-in-pg-catalog%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Finding foreign keys missing indexes on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fkaveland.no%2fposts%2f2025-04-04-finding-missing-indexes-in-pg-catalog%2f&title=Finding%20foreign%20keys%20missing%20indexes"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Finding foreign keys missing indexes on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fkaveland.no%2fposts%2f2025-04-04-finding-missing-indexes-in-pg-catalog%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Finding foreign keys missing indexes on whatsapp" href="https://api.whatsapp.com/send?text=Finding%20foreign%20keys%20missing%20indexes%20-%20https%3a%2f%2fkaveland.no%2fposts%2f2025-04-04-finding-missing-indexes-in-pg-catalog%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Finding foreign keys missing indexes on telegram" href="https://telegram.me/share/url?text=Finding%20foreign%20keys%20missing%20indexes&amp;url=https%3a%2f%2fkaveland.no%2fposts%2f2025-04-04-finding-missing-indexes-in-pg-catalog%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Finding foreign keys missing indexes on ycombinator" href="https://news.ycombinator.com/submitlink?t=Finding%20foreign%20keys%20missing%20indexes&u=https%3a%2f%2fkaveland.no%2fposts%2f2025-04-04-finding-missing-indexes-in-pg-catalog%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://kaveland.no/>Robin's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>