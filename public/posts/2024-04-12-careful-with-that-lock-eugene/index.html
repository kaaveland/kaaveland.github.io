<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Careful with That Lock, Eugene | Robin's blog</title>
<meta name=keywords content="postgres,eugene"><meta name=description content="It is rewarding to work on software that people care about and use all around
the clock. This constant usage means we can&rsquo;t simply take the system offline for
maintenance without upsetting users. Therefore, techniques that allow us to
update the software seamlessly without downtime or compromising service
quality are incredibly valuable.
Most projects I&rsquo;ve worked on use a relational database for persistence, and have
some sort of migration tool like flyway or liquibase to make changes to the
database schema. This post is about a particular kind of migration situation
that, in my experience, most developers who work on such projects will encounter
at some point in their career. They will want to apply a simple, and seemingly
innocent migration, like adding a column to a table and it&rsquo;ll cause some number
of requests to fail, or maybe even a small outage. There are some tricks we can
use here to reduce risk and automatically detect some patterns that cause this
problem."><meta name=author content="Robin Kåveland"><link rel=canonical href=https://kaveland.no/posts/2024-04-12-careful-with-that-lock-eugene/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://kaveland.no/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kaveland.no/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kaveland.no/favicon-32x32.png><link rel=apple-touch-icon href=https://kaveland.no/apple-touch-icon.png><link rel=mask-icon href=https://kaveland.no/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kaveland.no/posts/2024-04-12-careful-with-that-lock-eugene/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer data-domain=kaveland.no src=https://plausible.io/js/script.js></script><meta property="og:title" content="Careful with That Lock, Eugene"><meta property="og:description" content="It is rewarding to work on software that people care about and use all around
the clock. This constant usage means we can&rsquo;t simply take the system offline for
maintenance without upsetting users. Therefore, techniques that allow us to
update the software seamlessly without downtime or compromising service
quality are incredibly valuable.
Most projects I&rsquo;ve worked on use a relational database for persistence, and have
some sort of migration tool like flyway or liquibase to make changes to the
database schema. This post is about a particular kind of migration situation
that, in my experience, most developers who work on such projects will encounter
at some point in their career. They will want to apply a simple, and seemingly
innocent migration, like adding a column to a table and it&rsquo;ll cause some number
of requests to fail, or maybe even a small outage. There are some tricks we can
use here to reduce risk and automatically detect some patterns that cause this
problem."><meta property="og:type" content="article"><meta property="og:url" content="https://kaveland.no/posts/2024-04-12-careful-with-that-lock-eugene/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-12T00:00:00+00:00"><meta property="article:modified_time" content="2024-04-12T00:00:00+00:00"><meta property="og:site_name" content="Robin's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Careful with That Lock, Eugene"><meta name=twitter:description content="It is rewarding to work on software that people care about and use all around
the clock. This constant usage means we can&rsquo;t simply take the system offline for
maintenance without upsetting users. Therefore, techniques that allow us to
update the software seamlessly without downtime or compromising service
quality are incredibly valuable.
Most projects I&rsquo;ve worked on use a relational database for persistence, and have
some sort of migration tool like flyway or liquibase to make changes to the
database schema. This post is about a particular kind of migration situation
that, in my experience, most developers who work on such projects will encounter
at some point in their career. They will want to apply a simple, and seemingly
innocent migration, like adding a column to a table and it&rsquo;ll cause some number
of requests to fail, or maybe even a small outage. There are some tricks we can
use here to reduce risk and automatically detect some patterns that cause this
problem."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kaveland.no/posts/"},{"@type":"ListItem","position":2,"name":"Careful with That Lock, Eugene","item":"https://kaveland.no/posts/2024-04-12-careful-with-that-lock-eugene/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Careful with That Lock, Eugene","name":"Careful with That Lock, Eugene","description":"It is rewarding to work on software that people care about and use all around the clock. This constant usage means we can\u0026rsquo;t simply take the system offline for maintenance without upsetting users. Therefore, techniques that allow us to update the software seamlessly without downtime or compromising service quality are incredibly valuable.\nMost projects I\u0026rsquo;ve worked on use a relational database for persistence, and have some sort of migration tool like flyway or liquibase to make changes to the database schema. This post is about a particular kind of migration situation that, in my experience, most developers who work on such projects will encounter at some point in their career. They will want to apply a simple, and seemingly innocent migration, like adding a column to a table and it\u0026rsquo;ll cause some number of requests to fail, or maybe even a small outage. There are some tricks we can use here to reduce risk and automatically detect some patterns that cause this problem.\n","keywords":["postgres","eugene"],"articleBody":"It is rewarding to work on software that people care about and use all around the clock. This constant usage means we can’t simply take the system offline for maintenance without upsetting users. Therefore, techniques that allow us to update the software seamlessly without downtime or compromising service quality are incredibly valuable.\nMost projects I’ve worked on use a relational database for persistence, and have some sort of migration tool like flyway or liquibase to make changes to the database schema. This post is about a particular kind of migration situation that, in my experience, most developers who work on such projects will encounter at some point in their career. They will want to apply a simple, and seemingly innocent migration, like adding a column to a table and it’ll cause some number of requests to fail, or maybe even a small outage. There are some tricks we can use here to reduce risk and automatically detect some patterns that cause this problem.\nThis post was discussed on hacker news here.\nScenario 1 We’ll use postgres to describe the setup and scenario, with the following simple schema:\nCREATE TABLE documents(id serial PRIMARY KEY, document text); This scenario has 2 transactions in it:\nA is a transaction that wants to complete 2 statements, one fast and one slow, both modifications to the database. B is a transaction that only wants to read a single document. I will start these in different psql shells and we’ll take a look at what happens.\nA adds a column to documents postgres=# BEGIN; BEGIN postgres=*# ALTER TABLE documents ADD COLUMN is_indexed bool; ALTER TABLE A is now holding an AccessExclusiveLock on documents, and all subsequent transactions that attempt to do anything with that table must wait:\npostgres=# SELECT l.relation::regclass AS object_name, l.mode, locktype, granted FROM pg_locks l JOIN pg_class c ON c.oid = l.relation JOIN pg_namespace n ON n.oid = c.relnamespace AND n.nspname != 'pg_catalog'; object_name | mode | locktype | granted -------------+---------------------+----------+--------- documents | AccessExclusiveLock | relation | t (1 row) A starts a slow statement Let’s say, then that A starts a slow statement, like filling in all the missing values for the new column (suppose that documents is a big table):\npostgres=*# UPDATE documents SET is_indexed = true; B attempts to read a single document postgres=# BEGIN; BEGIN postgres=*# SELECT document FROM documents WHERE id = 3; B is now blocked and must wait for A to finish:\n# SELECT l.relation::regclass AS object_name, l.mode, locktype, granted FROM pg_locks l JOIN pg_class c ON c.oid = l.relation JOIN pg_namespace n ON n.oid = c.relnamespace AND n.nspname != 'pg_catalog'; object_name | mode | locktype | granted ----------------+---------------------+----------+--------- documents_pkey | RowExclusiveLock | relation | t documents | RowExclusiveLock | relation | t documents | AccessExclusiveLock | relation | t documents | AccessShareLock | relation | f (4 rows) Once A commits successfully, B immediately executes. In this scenario, if B is a very frequent transaction type and A is very slow, this can seem like a partial outage that can impact users on the live system.\nThis scenario is essentially identical to one in which there’s a single migration statement that requires an AccessExclusiveLock and performs a table rewrite, such as adding a NOT NULL column with a DEFAULT value*.\nBut at least if A is fast, nothing bad can happen, right? Well…\nScenario 2 This scenario has 3 transactions in it:\nA is a slow transaction. It reads documents and puts all the documents somewhere, possibly a search engine or something. The search engine is having a particularly bad day today or perhaps A is just reading more data than it should. B is our migration. It wants to add a column to documents, so that the job that runs A can see which documents that have already been sent to the search engine. C represents one of many fast transactions, needle-in-the-haystack kind of transactions. For example users that have clicked a link from the search engine and want to retrieve the entire document to read it, instead of the summary from the search engine. There’s a particular interleaving of these that could cause a lot of C transactions to block, leading to time outs or hanging web pages and frustrated users.\nA reads documents postgres=*# SELECT document FROM documents; document ------------- Imagine a bunch of interesting documents (6 rows) At this point, A starts doing a bunch of indexing into a search engine, and it’s going to take a long time.\nB attempts to take an AccessExclusiveLock postgres=# BEGIN; BEGIN postgres=*# ALTER TABLE documents ADD COLUMN is_indexed boolean; This transaction is blocked because A has some locks that are in conflict with the AccessExclusiveLock on documents that B is trying to take. We can check pg_locks to see what the status is right now:\npostgres=# SELECT l.relation::regclass AS object_name, l.mode, locktype, granted FROM pg_locks l JOIN pg_class c ON c.oid = l.relation JOIN pg_namespace n ON n.oid = c.relnamespace AND n.nspname != 'pg_catalog'; object_name | mode | locktype | granted ----------------+---------------------+----------+--------- documents_pkey | AccessShareLock | relation | t documents | AccessShareLock | relation | t documents | AccessExclusiveLock | relation | f The two AccessShareLocks are held by A, which is slow and B is waiting for the AccessExclusiveLock.\nC attempts to read one row from documents postgres=# BEGIN; BEGIN postgres=*# SELECT document FROM documents where id = 3; C is now blocked, waiting to acquire an AccessShareLock:\npostgres=# SELECT l.relation::regclass AS object_name, l.mode, locktype, granted FROM pg_locks l JOIN pg_class c ON c.oid = l.relation JOIN pg_namespace n ON n.oid = c.relnamespace AND n.nspname != 'pg_catalog'; object_name | mode | locktype | granted ----------------+---------------------+----------+--------- documents_pkey | AccessShareLock | relation | t documents | AccessShareLock | relation | t documents | AccessExclusiveLock | relation | f documents | AccessShareLock | relation | f (4 rows) At this point, B can’t proceed because of A and C can’t proceed because of B. If B aborts and rolls back, all instances of C will be able to proceed. If A is fast enough, it might be that nobody notices anything, if it’s also true that B is fast. If A is slow enough, some people might start getting alerts and start an investigation before A commits.\nMitigations Scenario 1 would be resolved if we made A from that scenario into 2 migrations; the SELECT document FROM documents WHERE id = 3 transaction does not conflict with the locks that UPDATE documents SET is_indexed = true takes.\nFor the common example of wanting to add a NOT NULL-column, we can add the column without the NOT NULL constraint, but with the default value in a migration. This is pretty much instant. Then we can issue a second migration to populate the value (it’s safer still if we can do this in small batches to avoid long-running transactions), then a third migration to add the NOT NULL constraint.\nScenario 2 needs a different strategy. Maybe we can design the job so we can solve the problem by adding a new documents_index_status table that has a foreign key to documents?\nOnce you know these patterns, it’s easy to test how possible mitigations would work out by practicing with concurrent sessions and see what works and what blocks. What would be very nice however, would be to have some tooling that told you that you were about to do something potentially dangerous.\nDetection in CI/CD Recently I learned from a colleague that flyway has a very cool callback feature that will let you run queries in the same transaction as your migrations, and I’m realizing that there is a lot of potential to build nice tooling with this feature. I have taken a stab at detecting migrations that take AccessExclusiveLocks on tables that aren’t new. I do this in three steps.\nSnapshot pg_class before migration When flyway gives my callback the BEFORE_EACH_MIGRATE event, I take a snapshot of pg_class to temporarily store which relations that existed before the migration ran:\nCREATE TABLE pg_class_before_migrate as SELECT * FROM pg_class; The reason we do this is that we don’t want to yell wolf when migrations create new tables or indexes, since the locks only matter if other transactions try to use the relations concurrently with the migration.\nFind relation level AccessExclusiveLocks On the AFTER_EACH_MIGRATE event, I retrieve all relation level locks that my transaction has taken on database objects that existed before the migration ran. If the migration has issued a SET ROLE we may need to change role back to the one that created the pg_class_before_migrate-table.\nSELECT n.nspname::text AS schema_name, l.relation::regclass::text AS object_name FROM pg_locks l JOIN public.pg_class_before_migrate c ON c.oid = l.relation JOIN pg_namespace n ON n.oid = c.relnamespace WHERE l.locktype = 'relation' AND l.mode = 'AccessExclusiveLock' AND l.pid = pg_backend_pid(); -- Locks held by current transaction Clean up We probably shouldn’t leave that snapshot of pg_class hanging around forever:\nDROP TABLE pg_class_before_migrate; At this point, you can choose to have the CI/CD comment on the pull request that the migration will lock documents and therefore you should check what types of transactions that may try to use that table concurrently with the migration. Possibly have some LLM generate a helpful text about what could go wrong with the migration script? Maybe match the locks against a list of tables that are acceptable to lock, or a list of tables that are known to be dangerous to lock?\nFuture work Note that there are lots of corner cases still here, I’m very enthusiastic about lots of ideas in this space and definitely want to write and share some more code once I know more about what’s possible.\nTaking a snapshot of pg_class potentially also gives us another few things we can detect. If we can run these migrations against something like an anonymized copy of the production database, we may be able to issue ANALYZE before and after the migration to detect some table rewrites – such an operation should change the relationship between reltuples and relpages in pg_class, by increasing the size of the tuples. That might also allow us to flag migrations that rewrite large tables. We can also snapshot other tables from information_schema, or tables like pg_attribute to build a pretty good data structure describing the effect of the migration in terms of both schema and content.\nErrata It is no longer true since [postgres 11](https://postgrespro.com/docs/postgresql/11/release-11) that adding a not null column with a default value causes a table rewrite, unless the default value is `VOLATILE`, like generating a random uuid or fetching a timestamp. ","wordCount":"1759","inLanguage":"en","datePublished":"2024-04-12T00:00:00Z","dateModified":"2024-04-12T00:00:00Z","author":{"@type":"Person","name":"Robin Kåveland"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kaveland.no/posts/2024-04-12-careful-with-that-lock-eugene/"},"publisher":{"@type":"Organization","name":"Robin's blog","logo":{"@type":"ImageObject","url":"https://kaveland.no/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kaveland.no/ accesskey=h title="Robin's blog (Alt + H)">Robin's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kaveland.no/about/ title=about><span>about</span></a></li><li><a href=https://kaveland.no/projects/ title=projects><span>projects</span></a></li><li><a href=https://kaveland.no/eugene/ title=eugene><span>eugene</span></a></li><li><a href=https://kaveland.no/thumper/ title=thumper><span>thumper</span></a></li><li><a href=https://kaveland.no/tags/ title=tags><span>tags</span></a></li><li><a href=https://kaveland.no/archives/ title=archives><span>archives</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kaveland.no/>Home</a>&nbsp;»&nbsp;<a href=https://kaveland.no/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Careful with That Lock, Eugene</h1><div class=post-meta><span title='2024-04-12 00:00:00 +0000 UTC'>April 12, 2024</span>&nbsp;·&nbsp;9 min&nbsp;·&nbsp;1759 words&nbsp;·&nbsp;Robin Kåveland&nbsp;|&nbsp;<a href=https://github.com/kaaveland/kaaveland.github.io/content/posts/2024-04-12-careful-with-that-lock-eugene.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#scenario-1>Scenario 1</a><ul><li><a href=#a-adds-a-column-to-documents><code>A</code> adds a column to <code>documents</code></a></li><li><a href=#a-starts-a-slow-statement><code>A</code> starts a slow statement</a></li><li><a href=#b-attempts-to-read-a-single-document><code>B</code> attempts to read a single document</a></li></ul></li><li><a href=#scenario-2>Scenario 2</a><ul><li><a href=#a-reads-documents><code>A</code> reads <code>documents</code></a></li><li><a href=#b-attempts-to-take-an-accessexclusivelock><code>B</code> attempts to take an <code>AccessExclusiveLock</code></a></li><li><a href=#c-attempts-to-read-one-row-from-documents><code>C</code> attempts to read one row from <code>documents</code></a></li></ul></li><li><a href=#mitigations>Mitigations</a></li><li><a href=#detection-in-cicd>Detection in CI/CD</a><ul><li><a href=#snapshot-pg_class-before-migration>Snapshot <code>pg_class</code> before migration</a></li><li><a href=#find-relation-level-accessexclusivelocks>Find relation level <code>AccessExclusiveLock</code>s</a></li><li><a href=#clean-up>Clean up</a></li></ul></li><li><a href=#future-work>Future work</a></li><li><a href=#errata>Errata</a></li></ul></nav></div></details></div><div class=post-content><p>It is rewarding to work on software that people care about and use all around
the clock. This constant usage means we can&rsquo;t simply take the system offline for
maintenance without upsetting users. Therefore, techniques that allow us to
update the software seamlessly without downtime or compromising service
quality are incredibly valuable.</p><p>Most projects I&rsquo;ve worked on use a relational database for persistence, and have
some sort of migration tool like flyway or liquibase to make changes to the
database schema. This post is about a particular kind of migration situation
that, in my experience, most developers who work on such projects will encounter
at some point in their career. They will want to apply a simple, and seemingly
innocent migration, like adding a column to a table and it&rsquo;ll cause some number
of requests to fail, or maybe even a small outage. There are some tricks we can
use here to reduce risk and automatically detect some patterns that cause this
problem.</p><p>This post was discussed on hacker news <a href="https://news.ycombinator.com/item?id=40025148">here.</a></p><h2 id=scenario-1>Scenario 1<a hidden class=anchor aria-hidden=true href=#scenario-1>#</a></h2><p>We&rsquo;ll use postgres to describe the setup and scenario, with the following simple
schema:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>documents</span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=nb>serial</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w> </span><span class=n>document</span><span class=w> </span><span class=nb>text</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>This scenario has 2 transactions in it:</p><ul><li><code>A</code> is a transaction that wants to complete 2 statements, one fast and one
slow, both modifications to the database.</li><li><code>B</code> is a transaction that only wants to read a single document.</li></ul><p>I will start these in different <code>psql</code> shells and we&rsquo;ll take a look at what
happens.</p><h3 id=a-adds-a-column-to-documents><code>A</code> adds a column to <code>documents</code><a hidden class=anchor aria-hidden=true href=#a-adds-a-column-to-documents>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>BEGIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>postgres</span><span class=o>=*#</span><span class=w> </span><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>documents</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>COLUMN</span><span class=w> </span><span class=n>is_indexed</span><span class=w> </span><span class=n>bool</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w>
</span></span></span></code></pre></div><p><code>A</code> is now holding an <code>AccessExclusiveLock</code> on <code>documents</code>, and all subsequent
transactions that attempt to do anything with that table must wait:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>relation</span><span class=p>::</span><span class=n>regclass</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>object_name</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=k>mode</span><span class=p>,</span><span class=w> </span><span class=n>locktype</span><span class=p>,</span><span class=w> </span><span class=k>granted</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>pg_locks</span><span class=w> </span><span class=n>l</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>pg_class</span><span class=w> </span><span class=k>c</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>oid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>relation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>pg_namespace</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>n</span><span class=p>.</span><span class=n>oid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>relnamespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=n>n</span><span class=p>.</span><span class=n>nspname</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=s1>&#39;pg_catalog&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>object_name</span><span class=w> </span><span class=o>|</span><span class=w>        </span><span class=k>mode</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>locktype</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>granted</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-------------+---------------------+----------+---------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>documents</span><span class=w>   </span><span class=o>|</span><span class=w> </span><span class=n>AccessExclusiveLock</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>relation</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=a-starts-a-slow-statement><code>A</code> starts a slow statement<a hidden class=anchor aria-hidden=true href=#a-starts-a-slow-statement>#</a></h3><p>Let&rsquo;s say, then that <code>A</code> starts a slow statement, like filling in all the
missing values for the new column (suppose that <code>documents</code> is a big table):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=*#</span><span class=w> </span><span class=k>UPDATE</span><span class=w> </span><span class=n>documents</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>is_indexed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>true</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><h3 id=b-attempts-to-read-a-single-document><code>B</code> attempts to read a single document<a hidden class=anchor aria-hidden=true href=#b-attempts-to-read-a-single-document>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>BEGIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>postgres</span><span class=o>=*#</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>document</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>documents</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p><code>B</code> is now blocked and must wait for <code>A</code> to finish:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=o>#</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>relation</span><span class=p>::</span><span class=n>regclass</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>object_name</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=k>mode</span><span class=p>,</span><span class=w> </span><span class=n>locktype</span><span class=p>,</span><span class=w> </span><span class=k>granted</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>pg_locks</span><span class=w> </span><span class=n>l</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>pg_class</span><span class=w> </span><span class=k>c</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>oid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>relation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>pg_namespace</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>n</span><span class=p>.</span><span class=n>oid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>relnamespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=n>n</span><span class=p>.</span><span class=n>nspname</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=s1>&#39;pg_catalog&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>object_name</span><span class=w>   </span><span class=o>|</span><span class=w>        </span><span class=k>mode</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>locktype</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>granted</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----------------+---------------------+----------+---------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>documents_pkey</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>RowExclusiveLock</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>relation</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>documents</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>RowExclusiveLock</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=n>relation</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>documents</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>AccessExclusiveLock</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>relation</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>documents</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>AccessShareLock</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>relation</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>f</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>4</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>Once <code>A</code> commits successfully, <code>B</code> immediately executes. In this scenario, if
<code>B</code> is a very frequent transaction type and <code>A</code> is very slow, this can seem like
a partial outage that can impact users on the live system.</p><p>This scenario is essentially identical to one in which there&rsquo;s a single
migration statement that requires an <code>AccessExclusiveLock</code> <em>and</em> performs a
table rewrite, such as adding a <code>NOT NULL</code> column with a <code>DEFAULT</code>
<a href=#fixed-in-pg-11>value*</a>.</p><p>But at least if <code>A</code> is fast, nothing bad can happen, right? Well&mldr;</p><h2 id=scenario-2>Scenario 2<a hidden class=anchor aria-hidden=true href=#scenario-2>#</a></h2><p>This scenario has 3 transactions in it:</p><ul><li><code>A</code> is a slow transaction. It reads <code>documents</code> and puts all the documents
somewhere, possibly a search engine or something. The search engine is having
a particularly bad day today or perhaps <code>A</code> is just reading more data than it
should.</li><li><code>B</code> is our migration. It wants to add a column to <code>documents</code>, so that the job
that runs <code>A</code> can see which documents that have already been sent to the
search engine.</li><li><code>C</code> represents one of many fast transactions, needle-in-the-haystack kind of
transactions. For example users that have clicked a link from the search
engine and want to retrieve the entire document to read it, instead of the
summary from the search engine.</li></ul><p>There&rsquo;s a particular interleaving of these that could cause a lot of <code>C</code>
transactions to block, leading to time outs or hanging web pages and frustrated
users.</p><h3 id=a-reads-documents><code>A</code> reads <code>documents</code><a hidden class=anchor aria-hidden=true href=#a-reads-documents>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=*#</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>document</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>documents</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>document</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>Imagine</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>a</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>bunch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>of</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>interesting</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>documents</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>6</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>At this point, A starts doing a bunch of indexing into a search engine, and it&rsquo;s
going to take a long time.</p><h3 id=b-attempts-to-take-an-accessexclusivelock><code>B</code> attempts to take an <code>AccessExclusiveLock</code><a hidden class=anchor aria-hidden=true href=#b-attempts-to-take-an-accessexclusivelock>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>BEGIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>postgres</span><span class=o>=*#</span><span class=w> </span><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>documents</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>COLUMN</span><span class=w> </span><span class=n>is_indexed</span><span class=w> </span><span class=nb>boolean</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>This transaction is blocked because <code>A</code> has some locks that are in conflict with
the <code>AccessExclusiveLock</code> on <code>documents</code> that <code>B</code> is trying to take. We can
check <code>pg_locks</code> to see what the status is right now:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>relation</span><span class=p>::</span><span class=n>regclass</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>object_name</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=k>mode</span><span class=p>,</span><span class=w> </span><span class=n>locktype</span><span class=p>,</span><span class=w> </span><span class=k>granted</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>pg_locks</span><span class=w> </span><span class=n>l</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>pg_class</span><span class=w> </span><span class=k>c</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>oid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>relation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>pg_namespace</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>n</span><span class=p>.</span><span class=n>oid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>relnamespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=n>n</span><span class=p>.</span><span class=n>nspname</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=s1>&#39;pg_catalog&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>object_name</span><span class=w>   </span><span class=o>|</span><span class=w>        </span><span class=k>mode</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>locktype</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>granted</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----------------+---------------------+----------+---------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>documents_pkey</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>AccessShareLock</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>relation</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>documents</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>AccessShareLock</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>relation</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>documents</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>AccessExclusiveLock</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>relation</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>f</span><span class=w>
</span></span></span></code></pre></div><p>The two <code>AccessShareLock</code>s are held by <code>A</code>, which is slow and <code>B</code> is waiting for
the <code>AccessExclusiveLock</code>.</p><h3 id=c-attempts-to-read-one-row-from-documents><code>C</code> attempts to read one row from <code>documents</code><a hidden class=anchor aria-hidden=true href=#c-attempts-to-read-one-row-from-documents>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>BEGIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>BEGIN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>postgres</span><span class=o>=*#</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>document</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>documents</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p><code>C</code> is now blocked, waiting to acquire an <code>AccessShareLock</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>relation</span><span class=p>::</span><span class=n>regclass</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>object_name</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=k>mode</span><span class=p>,</span><span class=w> </span><span class=n>locktype</span><span class=p>,</span><span class=w> </span><span class=k>granted</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>pg_locks</span><span class=w> </span><span class=n>l</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>pg_class</span><span class=w> </span><span class=k>c</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>oid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>relation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>JOIN</span><span class=w> </span><span class=n>pg_namespace</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>n</span><span class=p>.</span><span class=n>oid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>relnamespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>AND</span><span class=w> </span><span class=n>n</span><span class=p>.</span><span class=n>nspname</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=s1>&#39;pg_catalog&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=n>object_name</span><span class=w>   </span><span class=o>|</span><span class=w>        </span><span class=k>mode</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>locktype</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>granted</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----------------+---------------------+----------+---------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>documents_pkey</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>AccessShareLock</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>relation</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>documents</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>AccessShareLock</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>relation</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>t</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>documents</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>AccessExclusiveLock</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>relation</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>f</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>documents</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>AccessShareLock</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=n>relation</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>f</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>4</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>At this point, <code>B</code> can&rsquo;t proceed because of <code>A</code> and <code>C</code> can&rsquo;t proceed because of
<code>B</code>. If <code>B</code> aborts and rolls back, all instances of <code>C</code> will be able to
proceed. If <code>A</code> is fast enough, it might be that nobody notices anything, if
it&rsquo;s also true that <code>B</code> is fast. If <code>A</code> is slow enough, some people might
start getting alerts and start an investigation before <code>A</code> commits.</p><h2 id=mitigations>Mitigations<a hidden class=anchor aria-hidden=true href=#mitigations>#</a></h2><p>Scenario 1 would be resolved if we made <code>A</code> from that scenario into 2
migrations; the <code>SELECT document FROM documents WHERE id = 3</code> transaction does
not conflict with the locks that <code>UPDATE documents SET is_indexed = true</code> takes.</p><p>For the common example of wanting to add a <code>NOT NULL</code>-column, we can add the
column without the <code>NOT NULL</code> constraint, but with the default value in a
migration. This is pretty much instant. Then we can issue a second migration to
populate the value (it&rsquo;s safer still if we can do this in small batches to avoid
long-running transactions), then a third migration to add the <code>NOT NULL</code>
constraint.</p><p>Scenario 2 needs a different strategy. Maybe we can design the job so we can
solve the problem by adding a new <code>documents_index_status</code> table that has a
foreign key to <code>documents</code>?</p><p>Once you know these patterns, it&rsquo;s easy to test how possible mitigations would
work out by practicing with concurrent sessions and see what works and what
blocks. What would be very nice however, would be to have some tooling that told
you that you were about to do something potentially dangerous.</p><h2 id=detection-in-cicd>Detection in CI/CD<a hidden class=anchor aria-hidden=true href=#detection-in-cicd>#</a></h2><p>Recently I learned from a colleague that flyway has a very cool
<a href=https://javadoc.io/doc/org.flywaydb/flyway-core/latest/org/flywaydb/core/api/callback/Callback.html>callback</a>
feature that will let you run queries in the same transaction as your
migrations, and I&rsquo;m realizing that there is a <em>lot of</em> potential to build nice
tooling with this feature. I have taken a stab at detecting migrations that take
<code>AccessExclusiveLock</code>s on tables that aren&rsquo;t new. I do this in three steps.</p><h3 id=snapshot-pg_class-before-migration>Snapshot <code>pg_class</code> before migration<a hidden class=anchor aria-hidden=true href=#snapshot-pg_class-before-migration>#</a></h3><p>When flyway gives my callback the <code>BEFORE_EACH_MIGRATE</code> event, I take a snapshot
of <code>pg_class</code> to temporarily store which relations that existed before the
migration ran:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>pg_class_before_migrate</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>pg_class</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>The reason we do this is that we don&rsquo;t want to yell wolf when migrations create
new tables or indexes, since the locks only matter if other transactions try to
use the relations concurrently with the migration.</p><h3 id=find-relation-level-accessexclusivelocks>Find relation level <code>AccessExclusiveLock</code>s<a hidden class=anchor aria-hidden=true href=#find-relation-level-accessexclusivelocks>#</a></h3><p>On the <code>AFTER_EACH_MIGRATE</code> event, I retrieve all relation level locks that my
transaction has taken on database objects that existed <em>before</em> the migration
ran. If the migration has issued a <code>SET ROLE</code> we may need to change role back to
the one that created the <code>pg_class_before_migrate</code>-table.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>SELECT</span><span class=w> </span><span class=n>n</span><span class=p>.</span><span class=n>nspname</span><span class=p>::</span><span class=nb>text</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>schema_name</span><span class=p>,</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>relation</span><span class=p>::</span><span class=n>regclass</span><span class=p>::</span><span class=nb>text</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>object_name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FROM</span><span class=w> </span><span class=n>pg_locks</span><span class=w> </span><span class=n>l</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>JOIN</span><span class=w> </span><span class=k>public</span><span class=p>.</span><span class=n>pg_class_before_migrate</span><span class=w> </span><span class=k>c</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>oid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>relation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>JOIN</span><span class=w> </span><span class=n>pg_namespace</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>n</span><span class=p>.</span><span class=n>oid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>relnamespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WHERE</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>locktype</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;relation&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>AND</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=k>mode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;AccessExclusiveLock&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>AND</span><span class=w> </span><span class=n>l</span><span class=p>.</span><span class=n>pid</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pg_backend_pid</span><span class=p>();</span><span class=w> </span><span class=c1>-- Locks held by current transaction
</span></span></span></code></pre></div><h3 id=clean-up>Clean up<a hidden class=anchor aria-hidden=true href=#clean-up>#</a></h3><p>We probably shouldn&rsquo;t leave that snapshot of <code>pg_class</code> hanging around forever:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>DROP</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>pg_class_before_migrate</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>At this point, you can choose to have the CI/CD comment on the pull request that
the migration will lock <code>documents</code> and therefore you should check what types of
transactions that may try to use that table concurrently with the
migration. Possibly have some LLM generate a helpful text about what could go
wrong with the migration script? Maybe match the locks against a list of
tables that are acceptable to lock, or a list of tables that are known to be
dangerous to lock?</p><h2 id=future-work>Future work<a hidden class=anchor aria-hidden=true href=#future-work>#</a></h2><p>Note that there are lots of corner cases still here, I&rsquo;m very enthusiastic about
lots of ideas in this space and definitely want to write and share some more
code once I know more about what&rsquo;s possible.</p><p>Taking a snapshot of <code>pg_class</code> potentially also gives us another few things we
can detect. If we can run these migrations against something like an anonymized
copy of the production database, we may be able to issue <code>ANALYZE</code> before and
after the migration to detect some table rewrites &ndash; such an operation <em>should</em>
change the relationship between <code>reltuples</code> and <code>relpages</code> in <code>pg_class</code>, by
increasing the size of the tuples. That might also allow us to flag migrations
that rewrite large tables. We can also snapshot other tables from
<code>information_schema</code>, or tables like <code>pg_attribute</code> to build a pretty good data
structure describing the effect of the migration in terms of both schema and
content.</p><h2 id=errata>Errata<a hidden class=anchor aria-hidden=true href=#errata>#</a></h2><div id=fixed-in-pg-11></div>It is no longer true since
[postgres 11](https://postgrespro.com/docs/postgresql/11/release-11) that adding a
not null column with a default value causes a table rewrite, unless the
default value is `VOLATILE`, like generating a random uuid or fetching a
timestamp.</div><footer class=post-footer><ul class=post-tags><li><a href=https://kaveland.no/tags/postgres/>Postgres</a></li><li><a href=https://kaveland.no/tags/eugene/>Eugene</a></li></ul><nav class=paginav><a class=prev href=https://kaveland.no/posts/2024-05-06-careful-with-that-lock-eugene-pt-2/><span class=title>« Prev</span><br><span>Careful with That Lock, Eugene: Part 2</span>
</a><a class=next href=https://kaveland.no/posts/2024-04-04-testcase-for-foreign-keys/><span class=title>Next »</span><br><span>How to test for missing indexes on foreign keys</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Careful with That Lock, Eugene on x" href="https://x.com/intent/tweet/?text=Careful%20with%20That%20Lock%2c%20Eugene&amp;url=https%3a%2f%2fkaveland.no%2fposts%2f2024-04-12-careful-with-that-lock-eugene%2f&amp;hashtags=postgres%2ceugene"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Careful with That Lock, Eugene on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fkaveland.no%2fposts%2f2024-04-12-careful-with-that-lock-eugene%2f&amp;title=Careful%20with%20That%20Lock%2c%20Eugene&amp;summary=Careful%20with%20That%20Lock%2c%20Eugene&amp;source=https%3a%2f%2fkaveland.no%2fposts%2f2024-04-12-careful-with-that-lock-eugene%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Careful with That Lock, Eugene on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fkaveland.no%2fposts%2f2024-04-12-careful-with-that-lock-eugene%2f&title=Careful%20with%20That%20Lock%2c%20Eugene"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Careful with That Lock, Eugene on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fkaveland.no%2fposts%2f2024-04-12-careful-with-that-lock-eugene%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Careful with That Lock, Eugene on whatsapp" href="https://api.whatsapp.com/send?text=Careful%20with%20That%20Lock%2c%20Eugene%20-%20https%3a%2f%2fkaveland.no%2fposts%2f2024-04-12-careful-with-that-lock-eugene%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Careful with That Lock, Eugene on telegram" href="https://telegram.me/share/url?text=Careful%20with%20That%20Lock%2c%20Eugene&amp;url=https%3a%2f%2fkaveland.no%2fposts%2f2024-04-12-careful-with-that-lock-eugene%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Careful with That Lock, Eugene on ycombinator" href="https://news.ycombinator.com/submitlink?t=Careful%20with%20That%20Lock%2c%20Eugene&u=https%3a%2f%2fkaveland.no%2fposts%2f2024-04-12-careful-with-that-lock-eugene%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://kaveland.no/>Robin's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>