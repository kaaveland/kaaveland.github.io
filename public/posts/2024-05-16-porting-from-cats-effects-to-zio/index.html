<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Porting an application from cats effects to ZIO | Robin's blog</title>
<meta name=keywords content="scala,zio,cats-effect"><meta name=description content="In my current project, we&rsquo;re working on a large-ish code base that is written in
Scala and uses cats effect as an effect
system in large parts of the code base. If you&rsquo;re not familiar with what an
effect system is, I think the most important detail is that it&rsquo;s a tool that
gives you certain superpowers if you promise to be honest about it when your
code does things that can be considered &ldquo;effectful&rdquo;, such as interacting with
the network or reading files. We use the IO monad from cats effect, which is a
wonderful way of writing async, concurrent code that looks a lot like
synchronous code."><meta name=author content="Robin K√•veland"><link rel=canonical href=https://kaveland.no/posts/2024-05-16-porting-from-cats-effects-to-zio/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://kaveland.no/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kaveland.no/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kaveland.no/favicon-32x32.png><link rel=apple-touch-icon href=https://kaveland.no/apple-touch-icon.png><link rel=mask-icon href=https://kaveland.no/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kaveland.no/posts/2024-05-16-porting-from-cats-effects-to-zio/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer data-domain=kaveland.no src=https://plausible.io/js/script.js></script><meta property="og:title" content="Porting an application from cats effects to ZIO"><meta property="og:description" content="In my current project, we&rsquo;re working on a large-ish code base that is written in
Scala and uses cats effect as an effect
system in large parts of the code base. If you&rsquo;re not familiar with what an
effect system is, I think the most important detail is that it&rsquo;s a tool that
gives you certain superpowers if you promise to be honest about it when your
code does things that can be considered &ldquo;effectful&rdquo;, such as interacting with
the network or reading files. We use the IO monad from cats effect, which is a
wonderful way of writing async, concurrent code that looks a lot like
synchronous code."><meta property="og:type" content="article"><meta property="og:url" content="https://kaveland.no/posts/2024-05-16-porting-from-cats-effects-to-zio/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-16T00:00:00+00:00"><meta property="article:modified_time" content="2024-05-16T00:00:00+00:00"><meta property="og:site_name" content="Robin's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Porting an application from cats effects to ZIO"><meta name=twitter:description content="In my current project, we&rsquo;re working on a large-ish code base that is written in
Scala and uses cats effect as an effect
system in large parts of the code base. If you&rsquo;re not familiar with what an
effect system is, I think the most important detail is that it&rsquo;s a tool that
gives you certain superpowers if you promise to be honest about it when your
code does things that can be considered &ldquo;effectful&rdquo;, such as interacting with
the network or reading files. We use the IO monad from cats effect, which is a
wonderful way of writing async, concurrent code that looks a lot like
synchronous code."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kaveland.no/posts/"},{"@type":"ListItem","position":2,"name":"Porting an application from cats effects to ZIO","item":"https://kaveland.no/posts/2024-05-16-porting-from-cats-effects-to-zio/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Porting an application from cats effects to ZIO","name":"Porting an application from cats effects to ZIO","description":"In my current project, we\u0026rsquo;re working on a large-ish code base that is written in Scala and uses cats effect as an effect system in large parts of the code base. If you\u0026rsquo;re not familiar with what an effect system is, I think the most important detail is that it\u0026rsquo;s a tool that gives you certain superpowers if you promise to be honest about it when your code does things that can be considered \u0026ldquo;effectful\u0026rdquo;, such as interacting with the network or reading files. We use the IO monad from cats effect, which is a wonderful way of writing async, concurrent code that looks a lot like synchronous code.\n","keywords":["scala","zio","cats-effect"],"articleBody":"In my current project, we‚Äôre working on a large-ish code base that is written in Scala and uses cats effect as an effect system in large parts of the code base. If you‚Äôre not familiar with what an effect system is, I think the most important detail is that it‚Äôs a tool that gives you certain superpowers if you promise to be honest about it when your code does things that can be considered ‚Äúeffectful‚Äù, such as interacting with the network or reading files. We use the IO monad from cats effect, which is a wonderful way of writing async, concurrent code that looks a lot like synchronous code.\nThis is the first project where I‚Äôve been using an effect system in Scala, and it‚Äôs been a fascinating experience. Something that I think is kind of challenging in our case is that we‚Äôve inherited a code base where a lot of code is dishonest about being effectful ‚Äì that‚Äôs to say, it simply existed before the rest of the code started using an effect system. Many of the libraries that we use do not integrate with our IO monad and use exceptions to handle errors, so there‚Äôs actually quite a lot of this code. Previously I‚Äôve only worked with IO in Haskell, where using it isn‚Äôt optional so this kind of challenge has been new to me and I don‚Äôt really have a good idea about how to handle it.\nOn the whole, I feel very happy about working with cats effects, but I do think that there‚Äôs an issue with this kind of ecosystem where it‚Äôs hard to gradually adopt it.\nDespite our happiness with cats effects, we‚Äôve ended up having to look at and consider ZIO for some of the things we do. Namely, we‚Äôve been instructed to offer GraphQL APIs and after testing a few options, we decided that caliban looks like the best option for us. It integrates really nicely with ZIO, and specifically ZQuery, which is a very cool library that makes it easier to batch and cache GraphQL queries efficiently. There‚Äôs a cool paper you can read about Haxl, which inspired ZQuery, although I have to warn that the paper isn‚Äôt light reading.\nA theory we had early on, is that it would be simpler for developers to work with only one effect system in the code base, and so if we needed to have ZIO anyway, we should consider porting the rest of the code base away from cats effects. This is something we decided to timebox and make an attempt at, and I thought it might be interesting to share some of the things we‚Äôve learned in the process.\nDevising a method to refactor There are a lot of common signatures between IO and ZIO, and we had strong reasons to believe that in many places, just changing the type would be enough. The first thing we did was to define an IO alias for ZIO, so that we could update the effect type we used across the whole code base by only editing import statements:\ntype IO[+A] = zio.Task[A] Replacing all imports cats.effect.IO with our IO alias was simple to do with simple search and replace, and some manual touch up for the most complex imports.\nAfter doing this, there was a fairly limited number of patterns we had to update, and some of them, we could fix by adding extension methods to our IO alias. Here‚Äôs a non-exhaustive list of things we needed to change:\nIO.raiseError became ZIO.fail IO.pure became ZIO.succeed IO.attempt became ZIO.either IO.apply | IO.delay became ZIO.attemptBlocking IOApp became ZIOAppDefault We had to import import zio.interop.catz.* all over the place for EitherT and things like that to work. On the whole, this stuff wasn‚Äôt so bad and took me the better part of a day to fix in the whole code base (which is maybe 150k lines?) by simply hitting compile and fixing the next error, one after another. It was boring, but not very hard.\nOnce that was done, I very quickly had a code base that compiled, and almost all the tests immediately passed. Most of the few test failures were easy to fix and were simple things like wrong translation of IO methods to ZIO methods.\nThe actual hard part There was one test failure that bothered me. In particular, the test was doing an actual call to a http4s service, and it was expecting to have some error handling done, but it simply wasn‚Äôt happening. It looked like our error handling was simply being ignored by ZIO, and I had a hard time figuring out why.\nThis honestly took me a few hours to figure out and I only realized what was wrong completely by accident. At some point I randomly remembered reading documentation about cats effects 2 that mentioned something about expecting only pure functions to be provided to map and flatMap. I decided to look up this section and see why my brain thought it might be relevant.\nWhen using map or flatMap it is not recommended to pass a side effectful function, as mapping functions should also be pure. [‚Ä¶] Note that as far as the actual behavior of IO is concerned, something like IO.pure(x).map(f) is equivalent with IO(f(x)) and IO.pure(x).flatMap(f) is equivalent with IO.defer(f(x)).\nBut you should not rely on this behavior, because it is NOT described by the laws required by the Sync type class and those laws are the only guarantees of behavior that you get. For example the above equivalence might be broken in the future in regards to error handling. So this behavior is currently there for safety reasons, but you should regard it as an implementation detail that could change in the future.\nI quickly realized that due to our code base having a lot of dishonest code that pretended to be pure, but wasn‚Äôt, we had a lot of places where we were passing side effectful functions to map and flatMap. cats effects is saying it can handle that (and that we should feel bad about doing it!), but how about ZIO?\nAn interesting difference between ZIO and IO is that ZIO has an error channel in the type, and we‚Äôll often see a signature like ZIO[Env, Throwable, A]. ZIO can also represent an ‚Äúinfallible‚Äù value, that is, something that can‚Äôt possibly fail: ZIO[Env, Nothing, A]. A value like that has to always contain an A, and could never contain an exception. If ZIO.flatMap were to allow functions that could throw exceptions, it would have to always return some variant like ZIO[Env, Throwable, A], which means you couldn‚Äôt compose ZIO[Env, Nothing, A] at all. So how does ZIO handle this?\nSo it turns out that this is what‚Äôs called a defect in ZIO. This is for unexpected and unrecoverable errors, like a throwing an Exception in map or flatMap. You can move such defects to the error channel of the ZIO monad by using .catchSomeDefect, like this:\n// some dishonest code that says it can't fail val infallible: ZIO[Any, Nothing, String] = ??? val fallible: ZIO[Any, Throwable, String] = infallible.catchSomeDefect { case e: JsonParseException =\u003e ZIO.fail(e) } Doing this operation at the top level of our http4s service made the test pass and for a moment, I was happy to see that we were able to refactor the entire code base in only a few days. But then I started having doubts.\nThere‚Äôs a lot of error handling code in a 150k line code base. There‚Äôs an impossibly large amount of calls to .map and .flatMap. How could we possibly verify that we‚Äôve installed all the necessary .catchSomeDefect calls in the right places? How could we possibly hope to verify that we‚Äôve done this correctly? I started to feel a bit of despair and realized I that this decision was too big to make without consulting others.\nOpting for the safer route After discussing this with the teams that share this code base, we decided that it was hard to accept this risk. The task of refactoring to use ZIO was something we had speculatively decided to be a good idea, but it was unclear to us what we would risk by not doing it. It seemed pretty clear that we would have to take a risk that was hard to quantify, in order to proceed with the refactoring, and for very uncertain benefits, it seemed best to let this one go. This is one of the cases where I think timeboxing is very valuable, in the end, this task did not cost us much time, and we learned a lot from it. It‚Äôs hard to say for sure, but I suspect that if we had sunk more cost into this, it would‚Äôve been harder to stop.\nAt this point we have both effect systems in use in our code base, and so far it seems to be working out fine. It also turns out that we‚Äôre taking the GraphQL part of the code out of the main code base and developing it in a separate repository, so we don‚Äôt have to worry about mixing the two effect systems in the same code base, so it may have all worked out for the best.\nSome lessons learned Time boxing is very valuable, and it is fun to work against the clock. ‚è∞ Doing a lot of work in a short time, then throwing it away is fine! üóëÔ∏è Conducting experiments is sometimes the best way to make sure that decisions are well-founded. ‚úÖ But often, there‚Äôs no right or wrong choice anyway, just different degrees of risk. üé≤ There‚Äôs a significant and big difference in the way that exceptions in .map and .flatMap are handled between IO and ZIO. ü§î It seems like gradually adopting an effect system is very hard, fraught with perils and probably not worth it in most cases. ü§î ","wordCount":"1649","inLanguage":"en","datePublished":"2024-05-16T00:00:00Z","dateModified":"2024-05-16T00:00:00Z","author":{"@type":"Person","name":"Robin K√•veland"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kaveland.no/posts/2024-05-16-porting-from-cats-effects-to-zio/"},"publisher":{"@type":"Organization","name":"Robin's blog","logo":{"@type":"ImageObject","url":"https://kaveland.no/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kaveland.no/ accesskey=h title="Robin's blog (Alt + H)">Robin's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kaveland.no/about/ title=about><span>about</span></a></li><li><a href=https://kaveland.no/projects/ title=projects><span>projects</span></a></li><li><a href=https://kaveland.no/eugene/ title=eugene><span>eugene</span></a></li><li><a href=https://kaveland.no/thumper/ title=thumper><span>thumper</span></a></li><li><a href=https://kaveland.no/tags/ title=tags><span>tags</span></a></li><li><a href=https://kaveland.no/archives/ title=archives><span>archives</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kaveland.no/>Home</a>&nbsp;¬ª&nbsp;<a href=https://kaveland.no/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Porting an application from cats effects to ZIO</h1><div class=post-meta><span title='2024-05-16 00:00:00 +0000 UTC'>May 16, 2024</span>&nbsp;¬∑&nbsp;8 min&nbsp;¬∑&nbsp;1649 words&nbsp;¬∑&nbsp;Robin K√•veland&nbsp;|&nbsp;<a href=https://github.com/kaaveland/kaaveland.github.io/content/posts/2024-05-16-porting-from-cats-effects-to-zio.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#devising-a-method-to-refactor>Devising a method to refactor</a></li><li><a href=#the-actual-hard-part>The actual hard part</a></li><li><a href=#opting-for-the-safer-route>Opting for the safer route</a></li><li><a href=#some-lessons-learned>Some lessons learned</a></li></ul></nav></div></details></div><div class=post-content><p>In my current project, we&rsquo;re working on a large-ish code base that is written in
Scala and uses <a href=https://typelevel.org/cats-effect/>cats effect</a> as an effect
system in large parts of the code base. If you&rsquo;re not familiar with what an
effect system is, I think the most important detail is that it&rsquo;s a tool that
gives you certain superpowers if you promise to be honest about it when your
code does things that can be considered &ldquo;effectful&rdquo;, such as interacting with
the network or reading files. We use the <code>IO</code> monad from cats effect, which is a
wonderful way of writing async, concurrent code that looks a lot like
synchronous code.</p><p>This is the first project where I&rsquo;ve been using an effect system in Scala, and
it&rsquo;s been a fascinating experience. Something that I think is kind of
challenging in our case is that we&rsquo;ve inherited a code base where a lot of
code is dishonest about being effectful &ndash; that&rsquo;s to say, it simply existed before
the rest of the code started using an effect system. Many of the libraries
that we use do not integrate with our <code>IO</code> monad and use exceptions to handle
errors, so there&rsquo;s actually quite a lot of this code. Previously I&rsquo;ve only worked with
<code>IO</code> in Haskell, where using it isn&rsquo;t optional so this kind of challenge has been
new to me and I don&rsquo;t really have a good idea about how to handle it.</p><p>On the whole, I feel very happy about working with cats effects, but I do think
that there&rsquo;s an issue with this kind of ecosystem where it&rsquo;s hard to gradually
adopt it.</p><p>Despite our happiness with cats effects, we&rsquo;ve ended up having to look at and
consider <a href=https://zio.dev/>ZIO</a> for some of the things we do. Namely, we&rsquo;ve
been instructed to offer GraphQL APIs and after testing a few options, we decided
that <a href=https://ghostdogpr.github.io/caliban/>caliban</a> looks like the best option
for us. It integrates really nicely with ZIO, and specifically ZQuery, which is
a very cool library that makes it easier to batch and cache GraphQL queries
efficiently. There&rsquo;s a cool <a href=http://simonmar.github.io/bib/papers/haxl-icfp14.pdf>paper</a>
you can read about Haxl, which inspired ZQuery, although I have to warn that
the paper isn&rsquo;t light reading.</p><p>A theory we had early on, is that it would be simpler for developers to work
with only one effect system in the code base, and so if we needed to have ZIO
anyway, we should consider porting the rest of the code base away from cats effects.
This is something we decided to timebox and make an attempt at, and I thought it
might be interesting to share some of the things we&rsquo;ve learned in the process.</p><h2 id=devising-a-method-to-refactor>Devising a method to refactor<a hidden class=anchor aria-hidden=true href=#devising-a-method-to-refactor>#</a></h2><p>There are <strong>a lot</strong> of common signatures between <code>IO</code> and <code>ZIO</code>, and we had
strong reasons to believe that in many places, just changing the type would be
enough. The first thing we did was to define an <code>IO</code> alias for <code>ZIO</code>, so that
we could update the effect type we used across the whole code base by only editing
import statements:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=k>type</span> <span class=kt>IO</span><span class=o>[</span><span class=kt>+A</span><span class=o>]</span> <span class=k>=</span> <span class=n>zio</span><span class=o>.</span><span class=nc>Task</span><span class=o>[</span><span class=kt>A</span><span class=o>]</span>
</span></span></code></pre></div><p>Replacing all imports <code>cats.effect.IO</code> with our <code>IO</code> alias was simple to do with
simple search and replace, and some manual touch up for the most complex imports.</p><p>After doing this, there was a fairly limited number of patterns we had to update,
and some of them, we could fix by adding extension methods to our <code>IO</code> alias. Here&rsquo;s
a non-exhaustive list of things we needed to change:</p><ul><li><code>IO.raiseError</code> became <code>ZIO.fail</code></li><li><code>IO.pure</code> became <code>ZIO.succeed</code></li><li><code>IO.attempt</code> became <code>ZIO.either</code></li><li><code>IO.apply | IO.delay</code> became <code>ZIO.attemptBlocking</code></li><li><code>IOApp</code> became <code>ZIOAppDefault</code></li><li>We had to import <code>import zio.interop.catz.*</code> all over the place for <code>EitherT</code> and
things like that to work.</li></ul><p>On the whole, this stuff wasn&rsquo;t so bad and took me the better part of a day to fix
in the whole code base (which is maybe 150k lines?) by simply hitting compile and
fixing the next error, one after another. It was boring, but not very hard.</p><p>Once that was done, I very quickly had a code base that compiled, and almost all
the tests immediately passed. Most of the few test failures were easy to fix and
were simple things like wrong translation of <code>IO</code> methods to <code>ZIO</code> methods.</p><h2 id=the-actual-hard-part>The actual hard part<a hidden class=anchor aria-hidden=true href=#the-actual-hard-part>#</a></h2><p>There was one test failure that bothered me. In particular, the test was doing an
actual call to a <a href=https://http4s.org/>http4s</a> service, and it was expecting to
have some error handling done, but it simply wasn&rsquo;t happening. It looked like our
error handling was simply being ignored by <code>ZIO</code>, and I had a hard time figuring
out why.</p><p>This honestly took me a few hours to figure out and I only realized what
was wrong completely by accident. At some point I randomly remembered reading
documentation about cats effects 2 that mentioned something about expecting only
pure functions to be provided to <code>map</code> and <code>flatMap</code>. I decided to look up
<a href=https://typelevel.org/cats-effect/docs/2.x/datatypes/io#use-pure-functions-in-map--flatmap>this section</a>
and see why my brain thought it might be relevant.</p><blockquote><p>When using map or flatMap it is not recommended to pass a side effectful function,
as mapping functions should also be pure.
[&mldr;]
Note that as far as the actual behavior of IO is concerned, something like
<code>IO.pure(x).map(f)</code> is equivalent with <code>IO(f(x))</code> and <code>IO.pure(x).flatMap(f)</code> is
equivalent with <code>IO.defer(f(x))</code>.</p><p>But you should not rely on this behavior, because it is NOT described by the
laws required by the <code>Sync</code> type class and those laws are the only guarantees
of behavior that you get. For example the above equivalence might be broken
in the future in regards to error handling. So this behavior is currently
there for safety reasons, but you should regard it as an implementation
detail that could change in the future.</p></blockquote><p>I quickly realized that due to our code base having a lot of dishonest code that
pretended to be pure, but wasn&rsquo;t, we had a lot of places where we were passing
side effectful functions to <code>map</code> and <code>flatMap</code>. cats effects is saying it can
handle that (and that we should feel bad about doing it!), but how about ZIO?</p><p>An interesting difference between <code>ZIO</code> and <code>IO</code> is that <code>ZIO</code> has an error
channel in the type, and we&rsquo;ll often see a signature like <code>ZIO[Env, Throwable, A]</code>.
<code>ZIO</code> can also represent an &ldquo;infallible&rdquo; value, that is, something that can&rsquo;t
possibly fail: <code>ZIO[Env, Nothing, A]</code>. A value like that has to always contain
an <code>A</code>, and could never contain an exception. If <code>ZIO.flatMap</code> were to allow
functions that could throw exceptions, it would have to always return some variant
like <code>ZIO[Env, Throwable, A]</code>, which means you couldn&rsquo;t compose <code>ZIO[Env, Nothing, A]</code>
at all. So how does <code>ZIO</code> handle this?</p><p>So it turns out that this is what&rsquo;s called a
<a href=https://zio.dev/reference/error-management/types/defects/>defect</a> in <code>ZIO</code>. This
is for unexpected and unrecoverable errors, like a throwing an <code>Exception</code> in <code>map</code> or
<code>flatMap</code>. You can move such defects to the error channel of the <code>ZIO</code> monad by using
<code>.catchSomeDefect</code>, like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=c1>// some dishonest code that says it can&#39;t fail
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>val</span> <span class=n>infallible</span><span class=k>:</span> <span class=kt>ZIO</span><span class=o>[</span><span class=kt>Any</span>, <span class=kt>Nothing</span>, <span class=kt>String</span><span class=o>]</span> <span class=k>=</span> <span class=o>???</span>
</span></span><span class=line><span class=cl><span class=k>val</span> <span class=n>fallible</span><span class=k>:</span> <span class=kt>ZIO</span><span class=o>[</span><span class=kt>Any</span>, <span class=kt>Throwable</span>, <span class=kt>String</span><span class=o>]</span> <span class=k>=</span> <span class=n>infallible</span><span class=o>.</span><span class=n>catchSomeDefect</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>case</span> <span class=n>e</span><span class=k>:</span> <span class=kt>JsonParseException</span> <span class=o>=&gt;</span> <span class=nc>ZIO</span><span class=o>.</span><span class=n>fail</span><span class=o>(</span><span class=n>e</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>Doing this operation at the top level of our http4s service made the test pass
and for a moment, I was happy to see that we were able to refactor the entire code
base in only a few days. But then I started having doubts.</p><p>There&rsquo;s a lot of error handling code in a 150k line code base. There&rsquo;s an impossibly
large amount of calls to <code>.map</code> and <code>.flatMap</code>. How could we possibly verify that
we&rsquo;ve installed all the necessary <code>.catchSomeDefect</code> calls in the right places? How
could we possibly hope to verify that we&rsquo;ve done this correctly? I started to feel
a bit of despair and realized I that this decision was too big to make without
consulting others.</p><h2 id=opting-for-the-safer-route>Opting for the safer route<a hidden class=anchor aria-hidden=true href=#opting-for-the-safer-route>#</a></h2><p>After discussing this with the teams that share this code base, we decided that it
was hard to accept this risk. The task of refactoring to use <code>ZIO</code> was something we had
speculatively decided to be a good idea, but it was unclear to us what we would risk by
<em>not</em> doing it. It seemed pretty clear that we would have to take a risk that was hard to
quantify, in order to proceed with the refactoring, and for very uncertain benefits, it
seemed best to let this one go. This is one of the cases where I think timeboxing is very
valuable, in the end, this task did not cost us much time, and we learned a lot from it.
It&rsquo;s hard to say for sure, but I suspect that if we had sunk more cost into this, it
would&rsquo;ve been harder to stop.</p><p>At this point we have both effect systems in use in our code base, and so far it seems
to be working out fine. It also turns out that we&rsquo;re taking the GraphQL part of the code
out of the main code base and developing it in a separate repository, so we don&rsquo;t have
to worry about mixing the two effect systems in the same code base, so it may have all
worked out for the best.</p><h2 id=some-lessons-learned>Some lessons learned<a hidden class=anchor aria-hidden=true href=#some-lessons-learned>#</a></h2><ul><li>Time boxing is very valuable, and it is fun to work against the clock. ‚è∞</li><li>Doing a lot of work in a short time, then throwing it away is fine! üóëÔ∏è</li><li>Conducting experiments is sometimes the best way to make sure that decisions are
well-founded. ‚úÖ</li><li>But often, there&rsquo;s no right or wrong choice anyway, just different degrees of risk. üé≤</li><li>There&rsquo;s a significant and big difference in the way that exceptions in <code>.map</code> and
<code>.flatMap</code> are handled between <code>IO</code> and <code>ZIO</code>. ü§î</li><li>It seems like gradually adopting an effect system is very hard, fraught with perils
and probably not worth it in most cases. ü§î</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://kaveland.no/tags/scala/>Scala</a></li><li><a href=https://kaveland.no/tags/zio/>Zio</a></li><li><a href=https://kaveland.no/tags/cats-effect/>Cats-Effect</a></li></ul><nav class=paginav><a class=prev href=https://kaveland.no/posts/2024-05-16-linting-postgres-migration-scripts/><span class=title>¬´ Prev</span><br><span>Linting postgres migration scripts</span>
</a><a class=next href=https://kaveland.no/posts/2024-05-06-careful-with-that-lock-eugene-pt-2/><span class=title>Next ¬ª</span><br><span>Careful with That Lock, Eugene: Part 2</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Porting an application from cats effects to ZIO on x" href="https://x.com/intent/tweet/?text=Porting%20an%20application%20from%20cats%20effects%20to%20ZIO&amp;url=https%3a%2f%2fkaveland.no%2fposts%2f2024-05-16-porting-from-cats-effects-to-zio%2f&amp;hashtags=scala%2czio%2ccats-effect"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Porting an application from cats effects to ZIO on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fkaveland.no%2fposts%2f2024-05-16-porting-from-cats-effects-to-zio%2f&amp;title=Porting%20an%20application%20from%20cats%20effects%20to%20ZIO&amp;summary=Porting%20an%20application%20from%20cats%20effects%20to%20ZIO&amp;source=https%3a%2f%2fkaveland.no%2fposts%2f2024-05-16-porting-from-cats-effects-to-zio%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Porting an application from cats effects to ZIO on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fkaveland.no%2fposts%2f2024-05-16-porting-from-cats-effects-to-zio%2f&title=Porting%20an%20application%20from%20cats%20effects%20to%20ZIO"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Porting an application from cats effects to ZIO on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fkaveland.no%2fposts%2f2024-05-16-porting-from-cats-effects-to-zio%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Porting an application from cats effects to ZIO on whatsapp" href="https://api.whatsapp.com/send?text=Porting%20an%20application%20from%20cats%20effects%20to%20ZIO%20-%20https%3a%2f%2fkaveland.no%2fposts%2f2024-05-16-porting-from-cats-effects-to-zio%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Porting an application from cats effects to ZIO on telegram" href="https://telegram.me/share/url?text=Porting%20an%20application%20from%20cats%20effects%20to%20ZIO&amp;url=https%3a%2f%2fkaveland.no%2fposts%2f2024-05-16-porting-from-cats-effects-to-zio%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Porting an application from cats effects to ZIO on ycombinator" href="https://news.ycombinator.com/submitlink?t=Porting%20an%20application%20from%20cats%20effects%20to%20ZIO&u=https%3a%2f%2fkaveland.no%2fposts%2f2024-05-16-porting-from-cats-effects-to-zio%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://kaveland.no/>Robin's blog</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>