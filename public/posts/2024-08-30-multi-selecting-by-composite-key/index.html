<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Batch operations using composite keys in postgres over jdbc | Robin's blog</title>
<meta name=keywords content="jdbc,java,scala,postgres,sql"><meta name=description content="Throughout a career as a software developer, you encounter many patterns. Some appear just often
enough to remember that they exist, but you still need to look them up every time. I&rsquo;ve discovered
that writing things down helps me remember them more easily. This particular pattern is very useful
for my current project. So, it&rsquo;s time to write it down and hopefully commit it to memory properly
this time. Although this post is specific to PostgreSQL, I&rsquo;m sure other databases have the necessary
features to achieve the same results efficiently."><meta name=author content="Robin Kåveland"><link rel=canonical href=https://kaveland.no/posts/2024-08-30-multi-selecting-by-composite-key/><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=https://kaveland.no/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://kaveland.no/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://kaveland.no/favicon-32x32.png><link rel=apple-touch-icon href=https://kaveland.no/apple-touch-icon.png><link rel=mask-icon href=https://kaveland.no/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://kaveland.no/posts/2024-08-30-multi-selecting-by-composite-key/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer data-domain=kaveland.no src=https://plausible.io/js/script.js></script><meta property="og:title" content="Batch operations using composite keys in postgres over jdbc"><meta property="og:description" content="Throughout a career as a software developer, you encounter many patterns. Some appear just often
enough to remember that they exist, but you still need to look them up every time. I&rsquo;ve discovered
that writing things down helps me remember them more easily. This particular pattern is very useful
for my current project. So, it&rsquo;s time to write it down and hopefully commit it to memory properly
this time. Although this post is specific to PostgreSQL, I&rsquo;m sure other databases have the necessary
features to achieve the same results efficiently."><meta property="og:type" content="article"><meta property="og:url" content="https://kaveland.no/posts/2024-08-30-multi-selecting-by-composite-key/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-30T00:00:00+00:00"><meta property="article:modified_time" content="2024-05-30T00:00:00+00:00"><meta property="og:site_name" content="Robin's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Batch operations using composite keys in postgres over jdbc"><meta name=twitter:description content="Throughout a career as a software developer, you encounter many patterns. Some appear just often
enough to remember that they exist, but you still need to look them up every time. I&rsquo;ve discovered
that writing things down helps me remember them more easily. This particular pattern is very useful
for my current project. So, it&rsquo;s time to write it down and hopefully commit it to memory properly
this time. Although this post is specific to PostgreSQL, I&rsquo;m sure other databases have the necessary
features to achieve the same results efficiently."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://kaveland.no/posts/"},{"@type":"ListItem","position":2,"name":"Batch operations using composite keys in postgres over jdbc","item":"https://kaveland.no/posts/2024-08-30-multi-selecting-by-composite-key/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Batch operations using composite keys in postgres over jdbc","name":"Batch operations using composite keys in postgres over jdbc","description":"Throughout a career as a software developer, you encounter many patterns. Some appear just often enough to remember that they exist, but you still need to look them up every time. I\u0026rsquo;ve discovered that writing things down helps me remember them more easily. This particular pattern is very useful for my current project. So, it\u0026rsquo;s time to write it down and hopefully commit it to memory properly this time. Although this post is specific to PostgreSQL, I\u0026rsquo;m sure other databases have the necessary features to achieve the same results efficiently.\n","keywords":["jdbc","java","scala","postgres","sql"],"articleBody":"Throughout a career as a software developer, you encounter many patterns. Some appear just often enough to remember that they exist, but you still need to look them up every time. I’ve discovered that writing things down helps me remember them more easily. This particular pattern is very useful for my current project. So, it’s time to write it down and hopefully commit it to memory properly this time. Although this post is specific to PostgreSQL, I’m sure other databases have the necessary features to achieve the same results efficiently.\nIn my current project, we have a lot of database tables with composite primary keys. Or in plain english, we have a bunch of tables where the primary key actually consists of more than one column. This is because a design principle for the database was to prefer natural keys over synthetic keys. While this is a good design principle, it does come with some mechanically annoying consequences. The topic for this post is the case where you have a bunch of keys in memory and need to instruct the database to delete all the corresponding rows. This is a fairly common kind of use case in web development, just think of all the list views you’ve seen with check boxes for deleting. With a primary key that is a single column, we can just fire off a prepared statement like this:\ndelete from orders where id = ANY(:ids); Then we just make sure to pass ids as a JDBC array type, and we get efficient bulk deletes. But this doesn’t work when the primary key is composite. What we would like to do, is to express something a lot like the following (illegal) SQL:\ndelete from orders where (customer_id, order_id) = ANY(:customers_and_orders); And then pass in customers_and_orders as a JDBC array of tuples. Last time I tried this, it wasn’t easily possible to create such a value using JDBC. Fortunately there’s still a way to do this efficiently, and it relies on a builtin function in postgres that is named unnest. The unnest function takes an array and returns a set of rows, one for each element. We can use it to construct a table value from a tuple of arrays. So suppose we have two arrays (just imagine we’re passing them in over JDBC for now):\npostgres=# select '{1, 2, 3, 4}' :: int[]; int4 ----------- {1,2,3,4} (1 row) postgres=# select '{one, two, three, four}' :: text[]; text ---------------------- {one,two,three,four} We can use unnest to turn them into a table like this:\npostgres=# select unnest('{1, 2, 3, 4}' :: int[]) as order_id, unnest('{one, two, three, four}' :: text[]) as customer_id; order_id | customer_id ----------+------------- 1 | one 2 | two 3 | three 4 | four Now we can easily use a subselect to delete the rows we want to target:\npostgres=# insert into orders(order_id, customer_id) values (1, 'one'), (2, 'two'); INSERT 0 2 postgres=# delete from orders where (order_id, customer_id) = any( select unnest('{1, 2, 3, 4}' :: int[]), unnest('{one, two, three, four}' :: text[])); DELETE 2 It is easy enough to pass two JDBC arrays of primitives, so this gets us to something that works. Note that if we want to do filtering using columns that aren’t part of a primary key, it’s important to remember that SQL has weird rules around NULL. Notably, if you compare anything to NULL, the result is NULL too, and this can come out weirdly in some cases with arrays, where you can also have NULL on two levels:\npostgres=# select unnest(NULL :: text[]), unnest('{1, 2, 3, 4}' :: int[]); unnest | unnest --------+-------- | 1 | 2 | 3 | 4 (4 rows) postgres=# select unnest('{one, two, three, NULL}' :: text[]), unnest('{1, 2, 3, 4}' :: int[]); unnest | unnest --------+-------- one | 1 two | 2 three | 3 | 4 (4 rows) With columns that are part of a primary key, it should be safe, as long as the array value that we pass in isn’t NULL, because postgres will automatically promote columns to NOT NULL if they become part of a primary key, and prevent us from altering them back to NULL.\nObviously this hack gets annoying if there are a lot of tables with composite keys that contain a lot of columns, and in such cases it may be worth adding a synthetic key to the table, just to make it more ergonomic to work with.\nPutting it all together Here’s a self-contained scala-cli script that shows how to do this from the JDBC-side. It won’t look too different in Java or Kotlin.\n//\u003e using scala \"3.5.0\" //\u003e using dep \"org.postgresql:postgresql:42.7.4\" import java.sql.DriverManager @main def run(): Unit = { val url = \"jdbc:postgresql://localhost:5432/postgres\" val connection = DriverManager.getConnection(url, \"postgres\", \"postgres\") val sql = \"delete from orders where (order_id, customer_id) = ANY(\" + \"select unnest(? :: int[]), unnest(? :: text[]))\"; val statement = connection.prepareStatement(sql) statement.setObject(1, Array(1, 2, 3)) statement.setObject(2, Array(\"one\", \"two\", \"three\")) println(statement.executeUpdate()) } If you don’t want to spend the storage space in your brain for this kind of pattern, my friend Øyvind Raddum Berg has implemented an excellent code generator for this kind of thing in his typo library. It takes care of some other annoyances with composite keys as well, like generating tedious joins, and mapping to/from the database for you. Currently, it generates Scala code, but I know that there’s secret plans to make it generate Kotlin and Java as well soon. I highly recommend taking a look, especially if you’re working with a lot of tables with composite keys.\nMore tips on composite keys? Making it easier to write joins Checking for missing indexes on foreign keys ","wordCount":"945","inLanguage":"en","datePublished":"2024-08-30T00:00:00Z","dateModified":"2024-05-30T00:00:00Z","author":{"@type":"Person","name":"Robin Kåveland"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://kaveland.no/posts/2024-08-30-multi-selecting-by-composite-key/"},"publisher":{"@type":"Organization","name":"Robin's blog","logo":{"@type":"ImageObject","url":"https://kaveland.no/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://kaveland.no/ accesskey=h title="Robin's blog (Alt + H)">Robin's blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://kaveland.no/about/ title=about><span>about</span></a></li><li><a href=https://kaveland.no/projects/ title=projects><span>projects</span></a></li><li><a href=https://kaveland.no/eugene/ title=eugene><span>eugene</span></a></li><li><a href=https://kaveland.no/thumper/ title=thumper><span>thumper</span></a></li><li><a href=https://kaveland.no/tags/ title=tags><span>tags</span></a></li><li><a href=https://kaveland.no/archives/ title=archives><span>archives</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://kaveland.no/>Home</a>&nbsp;»&nbsp;<a href=https://kaveland.no/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Batch operations using composite keys in postgres over jdbc</h1><div class=post-meta><span title='2024-08-30 00:00:00 +0000 UTC'>August 30, 2024</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;945 words&nbsp;·&nbsp;Robin Kåveland&nbsp;|&nbsp;<a href=https://github.com/kaaveland/kaaveland.github.io/content/posts/2024-08-30-multi-selecting-by-composite-key.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#putting-it-all-together>Putting it all together</a></li><li><a href=#more-tips-on-composite-keys>More tips on composite keys?</a></li></ul></nav></div></details></div><div class=post-content><p>Throughout a career as a software developer, you encounter many patterns. Some appear just often
enough to remember that they exist, but you still need to look them up every time. I&rsquo;ve discovered
that writing things down helps me remember them more easily. This particular pattern is very useful
for my current project. So, it&rsquo;s time to write it down and hopefully commit it to memory properly
this time. Although this post is specific to PostgreSQL, I&rsquo;m sure other databases have the necessary
features to achieve the same results efficiently.</p><p>In my current project, we have a lot of database tables with composite primary keys. Or in plain english, we
have a bunch of tables where the primary key actually consists of more than one column. This is because a
design principle for the database was to prefer natural keys over synthetic keys. While this is a good
design principle, it does come with some mechanically annoying consequences. The topic for this post is
the case where you have a bunch of keys in memory and need to instruct the database to delete all the
corresponding rows. This is a fairly common kind of use case in web development, just think of all the list
views you&rsquo;ve seen with check boxes for deleting. With a primary key that is a single column, we can just
fire off a prepared statement like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>delete</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>ANY</span><span class=p>(:</span><span class=n>ids</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>Then we just make sure to pass <code>ids</code> as a JDBC array type, and we get efficient bulk deletes. But this doesn&rsquo;t
work when the primary key is composite. What we would like to do, is to express something a lot like the following
(illegal) SQL:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=k>delete</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=p>(</span><span class=n>customer_id</span><span class=p>,</span><span class=w> </span><span class=n>order_id</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>ANY</span><span class=p>(:</span><span class=n>customers_and_orders</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>And then pass in <code>customers_and_orders</code> as a JDBC array of tuples. Last time I tried this, it wasn&rsquo;t easily possible
to create such a value using JDBC. Fortunately there&rsquo;s still a way to do this efficiently, and it relies on a builtin
function in postgres that is named <a href=https://www.postgresql.org/docs/current/functions-array.html>unnest</a>. The
<code>unnest</code> function takes an array and returns a set of rows, one for each element. We can use it to construct a
table value from a tuple of arrays. So suppose we have two arrays (just imagine we&rsquo;re passing them in over JDBC for now):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;{1, 2, 3, 4}&#39;</span><span class=w> </span><span class=p>::</span><span class=w> </span><span class=nb>int</span><span class=p>[];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>   </span><span class=n>int4</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-----------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=err>{</span><span class=mi>1</span><span class=p>,</span><span class=mi>2</span><span class=p>,</span><span class=mi>3</span><span class=p>,</span><span class=mi>4</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>1</span><span class=w> </span><span class=k>row</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=s1>&#39;{one, two, three, four}&#39;</span><span class=w> </span><span class=p>::</span><span class=w> </span><span class=nb>text</span><span class=p>[];</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>         </span><span class=nb>text</span><span class=w>         
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----------------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=err>{</span><span class=n>one</span><span class=p>,</span><span class=n>two</span><span class=p>,</span><span class=n>three</span><span class=p>,</span><span class=n>four</span><span class=err>}</span><span class=w>
</span></span></span></code></pre></div><p>We can use unnest to turn them into a table like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>select</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>unnest</span><span class=p>(</span><span class=s1>&#39;{1, 2, 3, 4}&#39;</span><span class=w> </span><span class=p>::</span><span class=w> </span><span class=nb>int</span><span class=p>[])</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>order_id</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>unnest</span><span class=p>(</span><span class=s1>&#39;{one, two, three, four}&#39;</span><span class=w> </span><span class=p>::</span><span class=w> </span><span class=nb>text</span><span class=p>[])</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>customer_id</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>order_id</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>customer_id</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>----------+-------------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=mi>1</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>one</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>2</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>two</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>3</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>three</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=mi>4</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>four</span><span class=w>
</span></span></span></code></pre></div><p>Now we can easily use a subselect to delete the rows we want to target:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>insert</span><span class=w> </span><span class=k>into</span><span class=w> </span><span class=n>orders</span><span class=p>(</span><span class=n>order_id</span><span class=p>,</span><span class=w> </span><span class=n>customer_id</span><span class=p>)</span><span class=w> </span><span class=k>values</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;one&#39;</span><span class=p>),</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;two&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>delete</span><span class=w> </span><span class=k>from</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=k>where</span><span class=w> </span><span class=p>(</span><span class=n>order_id</span><span class=p>,</span><span class=w> </span><span class=n>customer_id</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>any</span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=k>select</span><span class=w> </span><span class=k>unnest</span><span class=p>(</span><span class=s1>&#39;{1, 2, 3, 4}&#39;</span><span class=w> </span><span class=p>::</span><span class=w> </span><span class=nb>int</span><span class=p>[]),</span><span class=w> </span><span class=k>unnest</span><span class=p>(</span><span class=s1>&#39;{one, two, three, four}&#39;</span><span class=w> </span><span class=p>::</span><span class=w> </span><span class=nb>text</span><span class=p>[]));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DELETE</span><span class=w> </span><span class=mi>2</span><span class=w>
</span></span></span></code></pre></div><p>It is easy enough to pass two JDBC arrays of primitives, so this gets us to something that works. Note that if we
want to do filtering using columns that aren&rsquo;t part of a primary key, it&rsquo;s important to remember that SQL has
weird rules around <code>NULL</code>. Notably, if you compare anything to <code>NULL</code>, the result is <code>NULL</code> too, and this can
come out weirdly in some cases with arrays, where you can also have <code>NULL</code> on two levels:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=k>unnest</span><span class=p>(</span><span class=k>NULL</span><span class=w> </span><span class=p>::</span><span class=w> </span><span class=nb>text</span><span class=p>[]),</span><span class=w> </span><span class=k>unnest</span><span class=p>(</span><span class=s1>&#39;{1, 2, 3, 4}&#39;</span><span class=w> </span><span class=p>::</span><span class=w> </span><span class=nb>int</span><span class=p>[]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>unnest</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>unnest</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--------+--------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>        </span><span class=o>|</span><span class=w>      </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>      </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>      </span><span class=mi>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>      </span><span class=mi>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>4</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>postgres</span><span class=o>=#</span><span class=w> </span><span class=k>select</span><span class=w> </span><span class=k>unnest</span><span class=p>(</span><span class=s1>&#39;{one, two, three, NULL}&#39;</span><span class=w> </span><span class=p>::</span><span class=w> </span><span class=nb>text</span><span class=p>[]),</span><span class=w> </span><span class=k>unnest</span><span class=p>(</span><span class=s1>&#39;{1, 2, 3, 4}&#39;</span><span class=w> </span><span class=p>::</span><span class=w> </span><span class=nb>int</span><span class=p>[]);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=k>unnest</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>unnest</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>--------+--------
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w> </span><span class=n>one</span><span class=w>    </span><span class=o>|</span><span class=w>      </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>two</span><span class=w>    </span><span class=o>|</span><span class=w>      </span><span class=mi>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w> </span><span class=n>three</span><span class=w>  </span><span class=o>|</span><span class=w>      </span><span class=mi>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=o>|</span><span class=w>      </span><span class=mi>4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>(</span><span class=mi>4</span><span class=w> </span><span class=k>rows</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>With columns that are part of a primary key, it should be safe, as long as the array value that we pass in isn&rsquo;t <code>NULL</code>,
because postgres will automatically promote columns to <code>NOT NULL</code> if they become part of a primary key, and prevent
us from altering them back to <code>NULL</code>.</p><p>Obviously this hack gets annoying if there are a lot of tables with composite keys that contain a lot of columns, and
in such cases it may be worth adding a synthetic key to the table, just to make it more ergonomic to work with.</p><h2 id=putting-it-all-together>Putting it all together<a hidden class=anchor aria-hidden=true href=#putting-it-all-together>#</a></h2><p>Here&rsquo;s a self-contained <a href=https://scala-cli.virtuslab.org/>scala-cli</a> script that shows how to do this from the
JDBC-side. It won&rsquo;t look too different in Java or Kotlin.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-scala data-lang=scala><span class=line><span class=cl><span class=c1>//&gt; using scala &#34;3.5.0&#34;
</span></span></span><span class=line><span class=cl><span class=c1>//&gt; using dep &#34;org.postgresql:postgresql:42.7.4&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=k>import</span> <span class=nn>java.sql.DriverManager</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@main</span> <span class=k>def</span> <span class=n>run</span><span class=o>()</span><span class=k>:</span> <span class=kt>Unit</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=n>url</span> <span class=k>=</span> <span class=s>&#34;jdbc:postgresql://localhost:5432/postgres&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=n>connection</span> <span class=k>=</span> <span class=nc>DriverManager</span><span class=o>.</span><span class=n>getConnection</span><span class=o>(</span><span class=n>url</span><span class=o>,</span> <span class=s>&#34;postgres&#34;</span><span class=o>,</span> <span class=s>&#34;postgres&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=n>sql</span> <span class=k>=</span> <span class=s>&#34;delete from orders where (order_id, customer_id) = ANY(&#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;select unnest(? :: int[]), unnest(? :: text[]))&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>  <span class=k>val</span> <span class=n>statement</span> <span class=k>=</span> <span class=n>connection</span><span class=o>.</span><span class=n>prepareStatement</span><span class=o>(</span><span class=n>sql</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=n>statement</span><span class=o>.</span><span class=n>setObject</span><span class=o>(</span><span class=mi>1</span><span class=o>,</span> <span class=nc>Array</span><span class=o>(</span><span class=mi>1</span><span class=o>,</span> <span class=mi>2</span><span class=o>,</span> <span class=mi>3</span><span class=o>))</span>
</span></span><span class=line><span class=cl>  <span class=n>statement</span><span class=o>.</span><span class=n>setObject</span><span class=o>(</span><span class=mi>2</span><span class=o>,</span> <span class=nc>Array</span><span class=o>(</span><span class=s>&#34;one&#34;</span><span class=o>,</span> <span class=s>&#34;two&#34;</span><span class=o>,</span> <span class=s>&#34;three&#34;</span><span class=o>))</span>
</span></span><span class=line><span class=cl>  <span class=n>println</span><span class=o>(</span><span class=n>statement</span><span class=o>.</span><span class=n>executeUpdate</span><span class=o>())</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>If you don&rsquo;t want to spend the storage space in your brain for this kind of pattern, my friend Øyvind Raddum Berg has
implemented an excellent code generator for this kind of thing in his <a href=https://oyvindberg.github.io/typo/docs/>typo</a>
library. It takes care of some other annoyances with composite keys as well, like generating tedious joins, and
mapping to/from the database for you. Currently, it generates Scala code, but I know that there&rsquo;s secret plans
to make it generate Kotlin and Java as well soon. I highly recommend taking a look, especially
if you&rsquo;re working with a lot of tables with composite keys.</p><h2 id=more-tips-on-composite-keys>More tips on composite keys?<a hidden class=anchor aria-hidden=true href=#more-tips-on-composite-keys>#</a></h2><ul><li><a href=/posts/2025-04-30-that-join-is-natural>Making it easier to write joins</a></li><li><a href=/posts/2025-04-04-finding-missing-indexes-in-pg-catalog>Checking for missing indexes on foreign keys</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://kaveland.no/tags/jdbc/>Jdbc</a></li><li><a href=https://kaveland.no/tags/java/>Java</a></li><li><a href=https://kaveland.no/tags/scala/>Scala</a></li><li><a href=https://kaveland.no/tags/postgres/>Postgres</a></li><li><a href=https://kaveland.no/tags/sql/>Sql</a></li></ul><nav class=paginav><a class=prev href=https://kaveland.no/posts/2024-09-21-equals-any-over-where-in/><span class=title>« Prev</span><br><span>Consider using array operators over the SQL in operator</span>
</a><a class=next href=https://kaveland.no/posts/2024-06-27-salmon-ban/><span class=title>Next »</span><br><span>Norwegian Wild Salmon Fishing Ban of 2024</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Batch operations using composite keys in postgres over jdbc on x" href="https://x.com/intent/tweet/?text=Batch%20operations%20using%20composite%20keys%20in%20postgres%20over%20jdbc&amp;url=https%3a%2f%2fkaveland.no%2fposts%2f2024-08-30-multi-selecting-by-composite-key%2f&amp;hashtags=jdbc%2cjava%2cscala%2cpostgres%2csql"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Batch operations using composite keys in postgres over jdbc on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fkaveland.no%2fposts%2f2024-08-30-multi-selecting-by-composite-key%2f&amp;title=Batch%20operations%20using%20composite%20keys%20in%20postgres%20over%20jdbc&amp;summary=Batch%20operations%20using%20composite%20keys%20in%20postgres%20over%20jdbc&amp;source=https%3a%2f%2fkaveland.no%2fposts%2f2024-08-30-multi-selecting-by-composite-key%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Batch operations using composite keys in postgres over jdbc on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fkaveland.no%2fposts%2f2024-08-30-multi-selecting-by-composite-key%2f&title=Batch%20operations%20using%20composite%20keys%20in%20postgres%20over%20jdbc"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Batch operations using composite keys in postgres over jdbc on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fkaveland.no%2fposts%2f2024-08-30-multi-selecting-by-composite-key%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Batch operations using composite keys in postgres over jdbc on whatsapp" href="https://api.whatsapp.com/send?text=Batch%20operations%20using%20composite%20keys%20in%20postgres%20over%20jdbc%20-%20https%3a%2f%2fkaveland.no%2fposts%2f2024-08-30-multi-selecting-by-composite-key%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Batch operations using composite keys in postgres over jdbc on telegram" href="https://telegram.me/share/url?text=Batch%20operations%20using%20composite%20keys%20in%20postgres%20over%20jdbc&amp;url=https%3a%2f%2fkaveland.no%2fposts%2f2024-08-30-multi-selecting-by-composite-key%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Batch operations using composite keys in postgres over jdbc on ycombinator" href="https://news.ycombinator.com/submitlink?t=Batch%20operations%20using%20composite%20keys%20in%20postgres%20over%20jdbc&u=https%3a%2f%2fkaveland.no%2fposts%2f2024-08-30-multi-selecting-by-composite-key%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://kaveland.no/>Robin's blog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>